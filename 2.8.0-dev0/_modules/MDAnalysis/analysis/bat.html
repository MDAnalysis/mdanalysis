


  
    
  




<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="shortcut icon" href="../../../_static/logo/mda_favicon.ico">
</head>



<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDAnalysis.analysis.bat &mdash; MDAnalysis 2.8.0-dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/site.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=a9b57af3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/js/versions.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 2.8.0-dev0 documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >




  




<a href="../../../index.html">
  
    <img src="../../../_static/logo/mda_logo.png" class="logo" alt="Logo"/>
</a>


  
  
  
    <div class="version">
      2.8.0-dev0
    </div>
  



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div>
<div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
    <!-- <p class="caption" role="heading"></p> -->
    <ul>
        
        <li class="toctree-l1"><a class="reference internal" href="http://mdanalysis.org">MDAnalysis</a></li>
        
        <li class="toctree-l1"><a class="reference internal" href="http://userguide.mdanalysis.org">User guide</a></li>
        
        <li class="toctree-l1"><a class="reference internal" href="https://mdakits.mdanalysis.org/">MDAKits</a></li>
        
    </ul>
    
        <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/overview.html">1. Overview over MDAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology.html">2. The topology system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections.html">3. Selection commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/analysis_modules.html">4. Analysis modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology_modules.html">5. Topology modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/guesser_modules.html">6. Guesser modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/coordinates_modules.html">7. Coordinates modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/converters.html">8. Converter modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/trajectory_transformations.html">9. Trajectory transformations (“on-the-fly” transformations)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections_modules.html">10. Selection exporters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/auxiliary_modules.html">11. Auxiliary modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/core_modules.html">12. Core modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/visualization_modules.html">13. Visualization modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/lib_modules.html">14. Library functions — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.lib</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/version.html">15. Version information for MDAnalysis - <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.version</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/units.html">16. Constants and unit conversion — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.units</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/exceptions.html">17. Custom exceptions and warnings — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.exceptions</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/references.html">18. References</a></li>
</ul>

</div>

      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MDAnalysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">MDAnalysis.analysis.bat</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MDAnalysis.analysis.bat</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c1"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span>
<span class="c1">#</span>
<span class="c1"># MDAnalysis --- https://www.mdanalysis.org</span>
<span class="c1"># Copyright (c) 2006-2017 The MDAnalysis Development Team and contributors</span>
<span class="c1"># (see the file AUTHORS for the full list of names)</span>
<span class="c1">#</span>
<span class="c1"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c1">#</span>
<span class="c1"># Please cite your use of MDAnalysis in published work:</span>
<span class="c1">#</span>
<span class="c1"># R. J. Gowers, M. Linke, J. Barnoud, T. J. E. Reddy, M. N. Melo, S. L. Seyler,</span>
<span class="c1"># D. L. Dotson, J. Domanski, S. Buchoux, I. M. Kenney, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Python package for the rapid analysis of molecular dynamics</span>
<span class="c1"># simulations. In S. Benthall and S. Rostrup editors, Proceedings of the 15th</span>
<span class="c1"># Python in Science Conference, pages 102-109, Austin, TX, 2016. SciPy.</span>
<span class="c1"># doi: 10.25080/majora-629e541a-00e</span>
<span class="c1">#</span>
<span class="c1"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c1"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c1">#</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;Bond-Angle-Torsion coordinates analysis --- :mod:`MDAnalysis.analysis.bat`</span>
<span class="sd">===========================================================================</span>

<span class="sd">:Author: Soohaeng Yoo Willow and David Minh</span>
<span class="sd">:Year: 2020</span>
<span class="sd">:Copyright: GNU Public License, v2 or any higher version</span>

<span class="sd">.. versionadded:: 2.0.0</span>

<span class="sd">This module contains classes for interconverting between Cartesian and an</span>
<span class="sd">internal coordinate system, Bond-Angle-Torsion (BAT) coordinates</span>
<span class="sd">:footcite:p:`Chang2003`, for a given set of atoms or residues. This coordinate</span>
<span class="sd">system is designed to be complete, non-redundant, and minimize correlations</span>
<span class="sd">between degrees of freedom. Complete and non-redundant means that for N atoms</span>
<span class="sd">there will be 3N Cartesian coordinates and 3N BAT coordinates. Correlations are</span>
<span class="sd">minimized by using improper torsions, as described in :footcite:p:`Hikiri2016`.</span>

<span class="sd">More specifically, bond refers to the bond length, or distance between</span>
<span class="sd">a pair of bonded atoms. Angle refers to the bond angle, the angle between</span>
<span class="sd">a pair of bonds to a central atom. Torsion refers to the torsion angle.</span>
<span class="sd">For a set of four atoms a, b, c, and d, a torsion requires bonds between</span>
<span class="sd">a and b, b and c, and c and d. The torsion is the angle between a plane</span>
<span class="sd">containing atoms a, b, and c and another plane containing b, c, and d.</span>
<span class="sd">For a set of torsions that share atoms b and c, one torsion is defined as</span>
<span class="sd">the primary torsion. The others are defined as improper torsions, differences</span>
<span class="sd">between the raw torsion angle and the primary torsion. This definition reduces</span>
<span class="sd">the correlation between the torsion angles.</span>

<span class="sd">Each molecule also has six external coordinates that define its translation and</span>
<span class="sd">rotation in space. The three Cartesian coordinates of the first atom are the</span>
<span class="sd">molecule&#39;s translational degrees of freedom. Rotational degrees of freedom are</span>
<span class="sd">specified by the axis-angle convention. The rotation axis is a normalized vector</span>
<span class="sd">pointing from the first to second atom. It is described by the polar angle,</span>
<span class="sd">:math:`\phi`, and azimuthal angle, :math:`\theta`. :math:`\omega` is a third angle</span>
<span class="sd">that describes the rotation of the third atom about the axis.</span>

<span class="sd">This module was adapted from AlGDock :footcite:p:`Minh2020`.</span>


<span class="sd">See Also</span>
<span class="sd">--------</span>
<span class="sd">:class:`~MDAnalysis.analysis.dihedrals.Dihedral`</span>
<span class="sd">   class to calculate dihedral angles for a given set of atoms or residues</span>
<span class="sd">:func:`MDAnalysis.lib.distances.calc_dihedrals()`</span>
<span class="sd">   function to calculate dihedral angles from atom positions</span>


<span class="sd">Example applications</span>
<span class="sd">--------------------</span>

<span class="sd">The :class:`~MDAnalysis.analysis.bat.BAT` class defines bond-angle-torsion</span>
<span class="sd">coordinates based on the topology of an atom group and interconverts between</span>
<span class="sd">Cartesian and BAT coordinate systems.</span>

<span class="sd">For example, we can determine internal coordinates for residues 5-10</span>
<span class="sd">of adenylate kinase (AdK). The trajectory is included within the test data files::</span>

<span class="sd">   import MDAnalysis as mda</span>
<span class="sd">   from MDAnalysisTests.datafiles import PSF, DCD</span>
<span class="sd">   import numpy as np</span>

<span class="sd">   u = mda.Universe(PSF, DCD)</span>

<span class="sd">   # selection of atomgroups</span>
<span class="sd">   selected_residues = u.select_atoms(&quot;resid 5-10&quot;)</span>

<span class="sd">   from MDAnalysis.analysis.bat import BAT</span>
<span class="sd">   R = BAT(selected_residues)</span>

<span class="sd">   # Calculate BAT coordinates for a trajectory</span>
<span class="sd">   R.run()</span>

<span class="sd">After :meth:`R.run()&lt;BAT.run&gt;`, the coordinates can be accessed with</span>
<span class="sd">:attr:`R.results.bat&lt;BAT.bat&gt;`. The following code snippets assume that the</span>
<span class="sd">previous snippet has been executed.</span>

<span class="sd">Reconstruct Cartesian coordinates for the first frame::</span>

<span class="sd">   # Reconstruct Cartesian coordinates from BAT coordinates</span>
<span class="sd">   # of the first frame</span>
<span class="sd">   XYZ = R.Cartesian(R.results.bat[0,:])</span>

<span class="sd">   # The original and reconstructed Cartesian coordinates should all be close</span>
<span class="sd">   print(np.allclose(XYZ, selected_residues.positions, atol=1e-6))</span>

<span class="sd">Change a single torsion angle by :math:`\pi`::</span>

<span class="sd">   bat = R.results.bat[0,:]</span>
<span class="sd">   bat[bat.shape[0]-12] += np.pi</span>
<span class="sd">   XYZ = R.Cartesian(bat)</span>

<span class="sd">   # A good number of Cartesian coordinates should have been modified</span>
<span class="sd">   np.sum((XYZ - selected_residues.positions)&gt;1E-5)</span>

<span class="sd">Store data to the disk and load it again::</span>

<span class="sd">   # BAT coordinates can be saved to disk in the numpy binary format</span>
<span class="sd">   R.save(&#39;test.npy&#39;)</span>

<span class="sd">   # The BAT coordinates in a new BAT instance can be loaded from disk</span>
<span class="sd">   # instead of using the run() method.</span>
<span class="sd">   Rnew = BAT(selected_residues, filename=&#39;test.npy&#39;)</span>

<span class="sd">   # The BAT coordinates before and after disk I/O should be close</span>
<span class="sd">   print(np.allclose(Rnew.results.bat, R.results.bat))</span>


<span class="sd">Analysis classes</span>
<span class="sd">----------------</span>
<span class="sd">.. autoclass:: BAT</span>
<span class="sd">    :members:</span>
<span class="sd">    :inherited-members:</span>

<span class="sd">    .. attribute:: results.bat</span>

<span class="sd">        Contains the time series of the Bond-Angle-Torsion coordinates as a</span>
<span class="sd">        (nframes, 3N) :class:`numpy.ndarray` array. Each row corresponds to</span>
<span class="sd">        a frame in the trajectory. In each column, the first six elements</span>
<span class="sd">        describe external degrees of freedom. The first three are the center</span>
<span class="sd">        of mass of the initial atom. The next three specify the  external angles</span>
<span class="sd">        according to the axis-angle convention: :math:`\phi`, the polar angle,</span>
<span class="sd">        :math:`\theta`, the azimuthal angle, and :math:`\omega`, a third angle</span>
<span class="sd">        that describes the rotation of the third atom about the axis. The next</span>
<span class="sd">        three degrees of freedom are internal degrees of freedom for the root</span>
<span class="sd">        atoms: :math:`r_{01}`, the distance between atoms 0 and 1,</span>
<span class="sd">        :math:`r_{12}`, the distance between atoms 1 and 2,</span>
<span class="sd">        and :math:`a_{012}`, the angle between the three atoms.</span>
<span class="sd">        The rest of the array consists of all the other bond distances,</span>
<span class="sd">        all the other bond angles, and then all the other torsion angles.</span>


<span class="sd">References</span>
<span class="sd">----------</span>

<span class="sd">.. footbibliography::</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">AnalysisBase</span><span class="p">,</span> <span class="n">ResultsGroup</span>

<span class="kn">from</span> <span class="nn">MDAnalysis.lib.distances</span> <span class="kn">import</span> <span class="n">calc_bonds</span><span class="p">,</span> <span class="n">calc_angles</span><span class="p">,</span> <span class="n">calc_dihedrals</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.lib.mdamath</span> <span class="kn">import</span> <span class="n">make_whole</span>

<span class="kn">from</span> <span class="nn">..due</span> <span class="kn">import</span> <span class="n">due</span><span class="p">,</span> <span class="n">Doi</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sort_atoms_by_mass</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sorts a list of atoms by mass and then by index</span>

<span class="sd">    The atom index is used as a tiebreaker so that the ordering is reproducible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ag_o : list of Atoms</span>
<span class="sd">        List to sort</span>
<span class="sd">    reverse : bool</span>
<span class="sd">        Atoms will be in descending order</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ag_n : list of Atoms</span>
<span class="sd">        Sorted list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_find_torsions</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs a list of torsion angles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    root : AtomGroup</span>
<span class="sd">        First three atoms in the coordinate system</span>
<span class="sd">    atoms : AtomGroup</span>
<span class="sd">        Atoms that are allowed to be part of the torsion angle</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torsions : list of AtomGroup</span>
<span class="sd">        list of AtomGroup objects that define torsion angles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torsions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">selected_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_atoms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">torsionAdded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">selected_atoms</span><span class="p">:</span>
            <span class="c1"># Find a0, which is a new atom connected to the selected atom</span>
            <span class="n">a0_list</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a1</span><span class="o">.</span><span class="n">bonded_atoms</span> \
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_atoms</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a0</span> <span class="ow">in</span> <span class="n">a0_list</span><span class="p">:</span>
                <span class="c1"># Find a2, which is connected to a1, is not a terminal atom,</span>
                <span class="c1"># and has been selected</span>
                <span class="n">a2_list</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a1</span><span class="o">.</span><span class="n">bonded_atoms</span> \
                    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">!=</span><span class="n">a0</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonded_atoms</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">selected_atoms</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">a2_list</span><span class="p">:</span>
                    <span class="c1"># Find a3, which is</span>
                    <span class="c1"># connected to a2, has been selected, and is not a1</span>
                    <span class="n">a3_list</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">bonded_atoms</span> \
                        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">!=</span><span class="n">a1</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">selected_atoms</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">a3_list</span><span class="p">:</span>
                        <span class="c1"># Add the torsion to the list of torsions</span>
                        <span class="n">torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">]))</span>
                        <span class="c1"># Add the new atom to selected_atoms</span>
                        <span class="c1"># which extends the loop</span>
                        <span class="n">selected_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
                        <span class="n">torsionAdded</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>  <span class="c1"># out of the a3 loop</span>
                    <span class="k">break</span>  <span class="c1"># out of the a2 loop</span>
        <span class="k">if</span> <span class="n">torsionAdded</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected atoms:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">selected_atoms</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Torsions found:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Additional torsions not found.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torsions</span>


<div class="viewcode-block" id="BAT">
<a class="viewcode-back" href="../../../documentation_pages/analysis/bat.html#MDAnalysis.analysis.bat.BAT">[docs]</a>
<span class="k">class</span> <span class="nc">BAT</span><span class="p">(</span><span class="n">AnalysisBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate BAT coordinates for the specified AtomGroup.</span>

<span class="sd">    Bond-Angle-Torsions (BAT) internal coordinates will be computed for</span>
<span class="sd">    the group of atoms and all frame in the trajectory belonging to `ag`.</span>

<span class="sd">    .. versionchanged:: 2.8.0</span>
<span class="sd">       Enabled **parallel execution** with the ``multiprocessing`` and ``dask`` </span>
<span class="sd">       backends; use the new method :meth:`get_supported_backends` to see all </span>
<span class="sd">       supported backends.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_analysis_algorithm_is_parallelizable</span> <span class="o">=</span> <span class="kc">True</span>
      
<div class="viewcode-block" id="BAT.get_supported_backends">
<a class="viewcode-back" href="../../../documentation_pages/analysis/bat.html#MDAnalysis.analysis.bat.BAT.get_supported_backends">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_supported_backends</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;serial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;multiprocessing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dask&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span>
       <span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1002/jcc.26036&quot;</span><span class="p">),</span>
       <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Bond-Angle-Torsions Coordinate Transformation&quot;</span><span class="p">,</span>
       <span class="n">path</span><span class="o">=</span><span class="s2">&quot;MDAnalysis.analysis.bat.BAT&quot;</span><span class="p">,</span>
    <span class="p">)</span>
   
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">initial_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ag : AtomGroup or Universe</span>
<span class="sd">            Group of atoms for which the BAT coordinates are calculated.</span>
<span class="sd">            `ag` must have a bonds attribute.</span>
<span class="sd">            If unavailable, bonds may be guessed using</span>
<span class="sd">            :meth:`AtomGroup.guess_bonds &lt;MDAnalysis.core.groups.AtomGroup.guess_bonds&gt;`.</span>
<span class="sd">            `ag` must only include one molecule.</span>
<span class="sd">            If a trajectory is associated with the atoms, then the computation</span>
<span class="sd">            iterates over the trajectory.</span>
<span class="sd">        initial_atom : :class:`Atom &lt;MDAnalysis.core.groups.Atom&gt;`</span>
<span class="sd">            The atom whose Cartesian coordinates define the translation</span>
<span class="sd">            of the molecule. If not specified, the heaviest terminal atom</span>
<span class="sd">            will be selected.</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of a numpy binary file containing a saved bat array.</span>
<span class="sd">            If filename is not ``None``, the data will be loaded from this file</span>
<span class="sd">            instead of being recalculated using the run() method.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If `ag` does not contain a bonds attribute</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `ag` contains more than one molecule</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BAT</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="n">ag</span>

        <span class="c1"># Check that the ag contains bonds</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">,</span> <span class="s1">&#39;bonds&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;AtomGroup has no attribute bonds&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;AtomGroup has more than one molecule&#39;</span><span class="p">)</span>

        <span class="c1"># Determine the root</span>
        <span class="c1"># The initial atom must be a terminal atom</span>
        <span class="n">terminal_atoms</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span>\
            <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">initial_atom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Select the heaviest root atoms from the heaviest terminal atom</span>
            <span class="n">initial_atom</span> <span class="o">=</span> <span class="n">terminal_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">initial_atom</span> <span class="ow">in</span> <span class="n">terminal_atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Initial atom is not a terminal atom&#39;</span><span class="p">)</span>
        <span class="c1"># The next atom in the root is bonded to the initial atom</span>
        <span class="c1"># Since the initial atom is a terminal atom, there is only</span>
        <span class="c1"># one bonded atom</span>
        <span class="n">second_atom</span> <span class="o">=</span> <span class="n">initial_atom</span><span class="o">.</span><span class="n">bonded_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The last atom in the root is the heaviest atom</span>
        <span class="c1"># bonded to the second atom</span>
        <span class="c1"># If there are more than three atoms,</span>
        <span class="c1"># then the last atom cannot be a terminal atom.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">third_atom</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span>\
                <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">second_atom</span><span class="o">.</span><span class="n">bonded_atoms</span> \
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span><span class="o">!=</span><span class="n">initial_atom</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminal_atoms</span><span class="p">)],</span> \
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">third_atom</span> <span class="o">=</span> <span class="n">_sort_atoms_by_mass</span><span class="p">(</span>\
                <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">second_atom</span><span class="o">.</span><span class="n">bonded_atoms</span> \
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span><span class="o">!=</span><span class="n">initial_atom</span><span class="p">)],</span> \
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">initial_atom</span><span class="p">,</span> <span class="n">second_atom</span><span class="p">,</span> <span class="n">third_atom</span><span class="p">])</span>

        <span class="c1"># Construct a list of torsion angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span> <span class="o">=</span> <span class="n">_find_torsions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">)</span>

        <span class="c1"># Get indices of the root and torsion atoms</span>
        <span class="c1"># in a Cartesian positions array that matches the AtomGroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_XYZ_inds</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">indices</span><span class="o">==</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> \
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_torsion_XYZ_inds</span> <span class="o">=</span> <span class="p">[[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">indices</span><span class="o">==</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> \
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">]</span>

        <span class="c1"># The primary torsion is the first torsion on the list</span>
        <span class="c1"># with the same central atoms</span>
        <span class="n">prior_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_torsion_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">prior_atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prior_atoms</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> \
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_atoms</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_primary_torsion_indices</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_torsion_indices</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">ag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ag2</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">ag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ag3</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">ag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ag4</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">AtomGroup</span><span class="p">([</span><span class="n">ag</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torsions</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Calculate coordinates based on the root atoms</span>
        <span class="c1"># The rotation axis is a normalized vector pointing from atom 0 to 1</span>
        <span class="c1"># It is described in two degrees of freedom</span>
        <span class="c1"># by the polar angle and azimuth</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="n">make_whole</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">v01</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
        <span class="n">v21</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span>
        <span class="c1"># Internal coordinates</span>
        <span class="n">r01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v01</span><span class="p">,</span><span class="n">v01</span><span class="p">))</span>  
        <span class="c1"># Distance between first two root atoms</span>
        <span class="n">r12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v21</span><span class="p">,</span><span class="n">v21</span><span class="p">))</span>  
        <span class="c1"># Distance between second two root atoms</span>
        <span class="c1"># Angle between root atoms</span>
        <span class="n">a012</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v01</span><span class="p">,</span><span class="n">v21</span><span class="p">)</span><span class="o">/</span>\
                              <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v01</span><span class="p">,</span><span class="n">v01</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v21</span><span class="p">,</span><span class="n">v21</span><span class="p">)))))</span>
        <span class="c1"># External coordinates</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">v01</span> <span class="o">/</span> <span class="n">r01</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Polar angle</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># Azimuthal angle</span>
        <span class="c1"># Rotation to the z axis</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">Rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cp</span> <span class="o">*</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct</span> <span class="o">*</span> <span class="n">sp</span><span class="p">,</span> <span class="o">-</span><span class="n">st</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">cp</span> <span class="o">*</span> <span class="n">st</span><span class="p">,</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">st</span><span class="p">,</span> <span class="n">ct</span><span class="p">]])</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">Rz</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
        <span class="c1"># Angle about the rotation axis</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">root_based</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">p0</span><span class="p">,</span> <span class="p">[</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">r01</span><span class="p">,</span> <span class="n">r12</span><span class="p">,</span> <span class="n">a012</span><span class="p">]))</span>

        <span class="c1"># Calculate internal coordinates from the torsion list</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="n">calc_bonds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ag2</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                           <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">calc_angles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_ag2</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_ag3</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                             <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="n">calc_dihedrals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_ag2</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_ag3</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_ag4</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                                  <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag1</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="c1"># When appropriate, calculate improper torsions</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">torsions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_torsion_indices</span><span class="p">]</span>
        <span class="n">shift</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_primary_torsion_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">torsions</span> <span class="o">-=</span> <span class="n">shift</span>
        <span class="c1"># Wrap torsions to between -np.pi and np.pi</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="p">((</span><span class="n">torsions</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">root_based</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">torsions</span><span class="p">))</span>

<div class="viewcode-block" id="BAT.load">
<a class="viewcode-back" href="../../../documentation_pages/analysis/bat.html#MDAnalysis.analysis.bat.BAT.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the bat trajectory from a file in numpy binary format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            name of numpy binary file</span>
<span class="sd">        start : int, optional</span>
<span class="sd">            start frame of analysis</span>
<span class="sd">        stop : int, optional</span>
<span class="sd">            stop frame of analysis</span>
<span class="sd">        step : int, optional</span>
<span class="sd">            number of frames to skip between each analysed frame</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        save: Saves the bat trajectory in a file in numpy binary format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Choosing frames&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Check array dimensions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dimensions of array in loaded file, &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">), differ from required &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;dimensions of (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="c1"># Check position of initial atom</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Position of initial atom in file &#39;</span> <span class="o">+</span> \
                <span class="s1">&#39;inconsistent with current trajectory in starting frame.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BAT.save">
<a class="viewcode-back" href="../../../documentation_pages/analysis/bat.html#MDAnalysis.analysis.bat.BAT.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the bat trajectory in a file in numpy binary format</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load: Loads the bat trajectory from a file in numpy binary format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">bat</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAT.Cartesian">
<a class="viewcode-back" href="../../../documentation_pages/analysis/bat.html#MDAnalysis.analysis.bat.BAT.Cartesian">[docs]</a>
    <span class="k">def</span> <span class="nf">Cartesian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bat_frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conversion of a single frame from BAT to Cartesian coordinates</span>

<span class="sd">        One application of this function is to determine the new</span>
<span class="sd">        Cartesian coordinates after modifying a specific torsion angle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bat_frame : numpy.ndarray</span>
<span class="sd">            an array with dimensions (3N,) with external then internal</span>
<span class="sd">            degrees of freedom based on the root atoms, followed by the bond,</span>
<span class="sd">            angle, and (proper and improper) torsion coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        XYZ : numpy.ndarray</span>
<span class="sd">            an array with dimensions (N,3) with Cartesian coordinates. The first</span>
<span class="sd">            dimension has the same ordering as the AtomGroup used to initialize</span>
<span class="sd">            the class. The molecule will be whole opposed to wrapped around a</span>
<span class="sd">            periodic boundary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split the bat vector into more convenient variables</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">bat_frame</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">bat_frame</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="p">(</span><span class="n">r01</span><span class="p">,</span> <span class="n">r12</span><span class="p">,</span> <span class="n">a012</span><span class="p">)</span> <span class="o">=</span> <span class="n">bat_frame</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">n_torsions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="n">bat_frame</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="n">n_torsions</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">bat_frame</span><span class="p">[</span><span class="n">n_torsions</span> <span class="o">+</span> <span class="mi">9</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_torsions</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bat_frame</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_torsions</span> <span class="o">+</span> <span class="mi">9</span><span class="p">:])</span>
        <span class="c1"># When appropriate, convert improper to proper torsions</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">torsions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_torsion_indices</span><span class="p">]</span>
        <span class="n">shift</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_primary_torsion_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">torsions</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="c1"># Wrap torsions to between -np.pi and np.pi</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="p">((</span><span class="n">torsions</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># Set initial root atom positions based on internal coordinates</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">r01</span><span class="p">])</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a012</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">r01</span> <span class="o">-</span> <span class="n">r12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a012</span><span class="p">)])</span>

        <span class="c1"># Rotate the third atom by the appropriate value</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
        <span class="n">so</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
        <span class="c1"># $R_Z(\omega)$</span>
        <span class="n">Romega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">co</span><span class="p">,</span> <span class="o">-</span><span class="n">so</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">so</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Romega</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="c1"># Rotate the second two atoms to point in the right direction</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="c1"># $R_Z(\phi) R_Y(\theta)$</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cp</span> <span class="o">*</span> <span class="n">ct</span><span class="p">,</span> <span class="o">-</span><span class="n">sp</span><span class="p">,</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">st</span><span class="p">],</span> <span class="p">[</span><span class="n">ct</span> <span class="o">*</span> <span class="n">sp</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">sp</span> <span class="o">*</span> <span class="n">st</span><span class="p">],</span>
                       <span class="p">[</span><span class="o">-</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ct</span><span class="p">]])</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">Re</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Re</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="c1"># Translate the first three atoms by the origin</span>
        <span class="n">p0</span> <span class="o">+=</span> <span class="n">origin</span>
        <span class="n">p1</span> <span class="o">+=</span> <span class="n">origin</span>
        <span class="n">p2</span> <span class="o">+=</span> <span class="n">origin</span>

        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">XYZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_XYZ_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p0</span>
        <span class="n">XYZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_XYZ_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="n">XYZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_XYZ_inds</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p2</span>

        <span class="c1"># Place the remaining atoms</span>
        <span class="k">for</span> <span class="p">((</span><span class="n">a0</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">),</span> <span class="n">r01</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">torsion</span><span class="p">)</span> \
            <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_torsion_XYZ_inds</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">torsions</span><span class="p">):</span>

            <span class="n">p1</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span>

            <span class="n">sn_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">cs_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">sn_tor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
            <span class="n">cs_tor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>

            <span class="n">v21</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span>
            <span class="n">v21</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v21</span><span class="p">,</span><span class="n">v21</span><span class="p">))</span>
            <span class="n">v32</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p3</span>
            <span class="n">v32</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v32</span><span class="p">,</span><span class="n">v32</span><span class="p">))</span>

            <span class="n">vp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v32</span><span class="p">,</span> <span class="n">v21</span><span class="p">)</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,i-&gt;&#39;</span><span class="p">,</span><span class="n">v21</span><span class="p">,</span><span class="n">v32</span><span class="p">)</span>

            <span class="n">sn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cs</span> <span class="o">*</span> <span class="n">cs</span><span class="p">),</span> <span class="mf">0.0000000001</span><span class="p">)</span>
            <span class="n">vp</span> <span class="o">=</span> <span class="n">vp</span> <span class="o">/</span> <span class="n">sn</span>
            <span class="n">vu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">v21</span><span class="p">)</span>

            <span class="n">XYZ</span><span class="p">[</span><span class="n">a0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> \
              <span class="n">r01</span><span class="o">*</span><span class="p">(</span><span class="n">vu</span><span class="o">*</span><span class="n">sn_ang</span><span class="o">*</span><span class="n">cs_tor</span> <span class="o">+</span> <span class="n">vp</span><span class="o">*</span><span class="n">sn_ang</span><span class="o">*</span><span class="n">sn_tor</span> <span class="o">-</span> <span class="n">v21</span><span class="o">*</span><span class="n">cs_ang</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">XYZ</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The atomgroup for which BAT are computed (read-only property)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span>

    <span class="k">def</span> <span class="nf">_get_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ResultsGroup</span><span class="p">(</span><span class="n">lookup</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bat&#39;</span><span class="p">:</span> <span class="n">ResultsGroup</span><span class="o">.</span><span class="n">ndarray_vstack</span><span class="p">})</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2024, Naveen Michaud-Agrawal, Elizabeth J. Denning, Christian Beckstein (logo), Joshua L. Adelman, Henok Ademtew, Shobhit Agarwal, Aya M. Alaa, Irfan Alibay, Kazi Shudipto Amin, Anshul Angaria, Luís Pedro Borges Araújo, Balasubramanian, Utkarsh Bansal, Patricio Barletta, Leonardo Barneschi, Jonathan Barnoud, Estefania Barreto-Ojeda, Tone Bengtsen, Alejandro Bernardin, Ninad Bhat, Mateusz Bieniek, Kavya Bisht, Wouter Boomsma, Jose Borreguero, Cédric Bouysset, Kevin Boyd, Meet Brijwani, Bart Bruininks, Sébastien Buchoux, Sören von Bülow, Yantong Cai, David Caplan, Yuanyu Chang, Pratham Chauhan, Matthieu Chavent, Haochuan Chen, Xu Hong Chen, Kathleen Clark, Jennifer A Clark, Orion Cohen, Charlie Cook, Ruggero Cortini, Nicholas Craven, Ramon Crehuet, Davide Cruz, Matthew Davies, Robert Delgado, John Detlefs, Xavier Deupi, Bradley Dice, Jan Domanski, David L. Dotson, Mark D. Driver, Ali Ehlen, Daniel J. Evans, Shujie Fan, Bjarne Feddersen, Lennard van der Feltz, Jake Fennick, Philip Fowler, Guillaume Fraux, Anirvinya G, Michael Gecht, Ahmed Salah Ghoneim, Mikhail Glagolev, William Glass, Jenna M. Swarthout Goddard, Joseph Goose, Alexander Gorfer, Richard J. Gowers, Lukas Grossar, Abhinav Gupta, Akshay Gupta, Pratik Gupta, Sumit Gupta, Benjamin Hall, Ameya Harmalkar, Ivan Hristov, Eugen Hruska, Kyle J. Huston, Siddharth Jain, Edis Jakupovic, Joe Jordan, Henrik Jäger, Uma D Kadam, Aditya Kamath, Jon Kapla, Ian M. Kenney, Aditya Keshari, Haleema Khan, Navya Khare, Utsav Khatu, Andrew William King, Henry Kobin, Abhishek A. Kognole, Kosuke Kudo, Atharva Kulkarni, Manish Kumar, Mohit Kumar, Shubham Kumar, Alia Lescoulie, Zhenbo Li, Max Linke, Philip Loche, Jinju Lu, Hugo MacDermott-Opeskin, Shaivi Malik, Egor Marin, Domenico Marson, Micaela Matta, Andrew R. McCluskey, Robert McGibbon, Kurt McKee, Rocco Meli, Manuel Nuno Melo, Marcelo C. R. Melo, Dominik &#39;Rathann&#39; Mierzejewski, David Minh, Geongi Moon, Sampurna Mukherjee, Henry Mull, Morgan L. Nance, Fiona B. Naughton, Alex Nesterenko, Hai Nguyen, Sang Young Noh, Meghan Osato, Daniele Padula, Nabarun Pal, Mattia F. Palermo, Dimitrios Papageorgiou, Rafael R. Pappalardo, Vishal Parmar, Danny Parton, Shakul Pathak, Christian Pfaendner, Joshua L. Phillips, Marcelo D. Poleto, Hannah Pollak, Kashish Punjani, Michael Quevillon, Vedant Rathore, Tyler Reddy, Pedro Reis, Paul Rigor, Andrea Rizzi, Xiaoxu Ruan, Carlos Yanez S., Utkarsh Saxena, Moritz Schaeffler, Alexander Schlaich, Marcello Sega, Ricky Sexton, Sean L. Seyler, Faraaz Shah, Sulay Shah, Abhishek Shandilya, Shubham Sharma, Laksh Krishna Sharma, Rishabh Shukla, Karthikeyan Singaravelan, Tamandeep Singh, Brigitta Sipőcz, Paul Smith, Andy Somogyi, Caio S. Souza, Kai Niklas Spauszus, David van der Spoel, Shantanu Srivastava, Lukas Stelzl, Jan Stevens, Gorman Stock, Philipp Stärk, Johannes Stöckelmaier, Fenil Suchak, Ayush Suhane, Filip T. Szczypiński, Sukeerti T, Matthijs Tadema, Valerij Talagayev, Joao Miguel Correia Teixeira, Paarth Thadani, Matthew W. Thompson, Hao Tian, Matteo Tiberti, Zaheer Timol, Wiep van der Toorn, Mieczyslaw Torchala, Aditi Tripathi, Heet Vekariya, Mark Verma, Josh Vermaas, Isaac Virshup, Lily Wang, Leon Wehrhan, Nestor Wendt, Lawson Woods, Zhiyi Wu, Tengyu Xie, Zhuyi Xue, Mingyi Xue, Alexander Yang, Juan Eiros Zamora, Johannes Zeman, Yibo Zhang, Raymond Zhao, Yuxuan Zhuang, Fabian Zills, and Oliver Beckstein.</p>
  </div>

  

<div class="footer"><p>Please see
    our <a href="https://www.mdanalysis.org/pages/privacy/">Privacy Policy</a>
    to learn how <a href="https://www.mdanalysis.org">MDAnalysis</a> collects data.</p>
    <script data-goatcounter="https://mdanalysis.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
    var versions_json_url = 'https://docs.mdanalysis.org/versions.json'
</script>

<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"></span>
        2.8.0-dev0
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
        <dl id="versionselector">
            <dt>Other Versions</dt>
        </dl>

    </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>