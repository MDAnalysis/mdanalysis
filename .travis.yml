version: ~> 1.0
language: generic
group: travis_latest

# Only build for develop
branches:
  only:
    - develop

matrix:
  fast_finish: true
  include:
    - python: 3.8
      name: "Power PC"
      os: linux
      #dist: focal
      arch: ppc64le
      #before_install:
      #  - wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-ppc64le.sh -O miniconda.sh
      #  - mkdir $HOME/.conda
      #  - bash miniconda.sh -b -p $HOME/miniconda
      #  - $HOME/miniconda/bin/conda init bash
      #  - cat $HOME/.bashrc
      #  - source $HOME/.bashrc
      #  - conda activate base
      #  - conda update --yes conda
      #  - conda install pip pytest==6.1.2 mmtf-python biopython networkx cython matplotlib-base scipy griddataformats hypothesis gsd codecov -c conda-forge biobuilds
      #  - pip install pytest-xdist
      #  - conda info
      #install:
      #  - (cd package/ && python setup.py develop) && (cd testsuite/ && python setup.py install)
      #script:
      #  # 4 threads per power9 cores, 2 cores = 8 threads
      #  - python -m pytest ./MDAnalysisTests --disable-pytest-warnings -n 8
      #after_success:
      #  - echo "Override this stage for ppc64le"

    - os: linux
      language: python
      arch: arm64-graviton2
      python: 3.8
      name: "ARM64"
      dist: focal
      virt: vm
      group: edge
      before_install:
        - python -m pip install cython numpy scipy
        - python -m pip install --no-build-isolation hypothesis matplotlib pytest pytest-cov pytest-xdist tqdm
      install:
        - cd package
        - python setup.py install
        - cd ../testsuite
        - python setup.py install
        - cd ..
      script:
        - cd testsuite
        - python -m pytest ./MDAnalysisTests --disable-pytest-warnings -n 8 -rsx --cov=MDAnalysis
      after_success:
        - echo "Override this stage for ARM64"

before_install:
  - wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-ppc64le.sh -O miniconda.sh
  - mkdir $HOME/.conda
  - bash miniconda.sh -b -p $HOME/miniconda
  - $HOME/miniconda/bin/conda init bash
  - cat $HOME/.bashrc
  - source $HOME/.bashrc
  - conda activate base
  - conda update --yes conda
  - conda install pip pytest==6.1.2 mmtf-python biopython networkx cython matplotlib-base scipy griddataformats hypothesis gsd codecov -c conda-forge biobuilds
  - pip install pytest-xdist
  - conda info
install:
  - (cd package/ && python setup.py develop) && (cd testsuite/ && python setup.py install)
script:
  # 4 threads per power9 cores, 2 cores = 8 threads
  - python -m pytest ./MDAnalysisTests --disable-pytest-warnings -n 8
after_success:
  - echo "Override this stage for now"
