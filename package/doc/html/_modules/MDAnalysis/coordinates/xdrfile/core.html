<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MDAnalysis.coordinates.xdrfile.core &mdash; MDAnalysis 0.11.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.11.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 0.11.0 documentation"
          href="../../../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../../../_static/mdanalysis-logo.ico"/>
    <link rel="top" title="MDAnalysis 0.11.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">MDAnalysis 0.11.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/mdanalysis-logo-200x150.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for MDAnalysis.coordinates.xdrfile.core</h1><div class="highlight"><pre>
<span class="c"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4 fileencoding=utf-8</span>
<span class="c">#</span>
<span class="c"># MDAnalysis --- http://www.MDAnalysis.org</span>
<span class="c"># Copyright (c) 2006-2015 Naveen Michaud-Agrawal, Elizabeth J. Denning, Oliver Beckstein</span>
<span class="c"># and contributors (see AUTHORS for the full list)</span>
<span class="c">#</span>
<span class="c"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c">#</span>
<span class="c"># Please cite your use of MDAnalysis in published work:</span>
<span class="c">#</span>
<span class="c"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common high-level Gromacs XDR functionality --- :mod:`MDAnalysis.coordinates.xdrfile.core`</span>
<span class="sd">==========================================================================================</span>

<span class="sd">The :mod:`MDAnalysis.coordinates.xdrfile.core` module contains generic</span>
<span class="sd">classes to access Gromacs_ XDR-encoded trajectory formats such as TRR</span>
<span class="sd">and XTC.</span>

<span class="sd">A generic Gromacs_ trajectory is simply called &quot;trj&quot; within this</span>
<span class="sd">module.</span>

<span class="sd">.. SeeAlso:: :mod:`MDAnalysis.coordinates.base` for the generic MDAnalysis base</span>
<span class="sd">             classes and :mod:`MDAnalysis.coordinates.xdrfile.libxdrfile2` for</span>
<span class="sd">             the low-level bindings to the XDR trajectories.</span>

<span class="sd">.. _Gromacs: http://www.gromacs.org</span>

<span class="sd">Generic xdr trj classes</span>
<span class="sd">-----------------------</span>

<span class="sd">The generic classes are subclassed to generate the specific classes</span>
<span class="sd">for the XTC and TRR format.</span>

<span class="sd">.. versionchanged:: 0.8.0</span>
<span class="sd">   The XTC/TRR I/O interface now uses</span>
<span class="sd">   :mod:`~MDAnalysis.coordinates.xdrfile.libxdrfile2`, which has seeking and</span>
<span class="sd">   indexing capabilities. Note that unlike</span>
<span class="sd">   :mod:`~MDAnalysis.coordinates.xdrfile.libxdrfile` before it,</span>
<span class="sd">   :mod:`~MDAnalysis.coordinates.xdrfile.libxdrfile2` is distributed under the</span>
<span class="sd">   GNU GENERAL PUBLIC LICENSE, version 2 (or higher).</span>

<span class="sd">.. versionchanged:: 0.9.0</span>
<span class="sd">   TrjReader now stores the offsets used for frame seeking automatically as a</span>
<span class="sd">   hidden file in the same directory as the source trajectory. These offsets</span>
<span class="sd">   are automatically retrieved upon TrjReader instantiation, resulting in</span>
<span class="sd">   substantially quicker initialization times for long trajectories. The</span>
<span class="sd">   ctime and filesize of the trajectory are stored with the offsets, and these</span>
<span class="sd">   are checked against the trajectory on load to ensure the offsets aren&#39;t</span>
<span class="sd">   stale. The offsets are automatically regenerated if they are stale or</span>
<span class="sd">   missing.</span>

<span class="sd">.. versionchanged:: 0.11.0</span>
<span class="sd">   Frames now 0-based instead of 1-based</span>

<span class="sd">.. autoclass:: Timestep</span>
<span class="sd">   :members:</span>
<span class="sd">.. autoclass:: TrjReader</span>
<span class="sd">   :members:</span>
<span class="sd">.. autoclass:: TrjWriter</span>
<span class="sd">   :members:</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">libxdrfile2</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.coordinates</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.coordinates.core</span> <span class="kn">import</span> <span class="n">triclinic_box</span><span class="p">,</span> <span class="n">triclinic_vectors</span>
<span class="kn">import</span> <span class="nn">MDAnalysis.core</span>
<span class="kn">from</span> <span class="nn">...lib.util</span> <span class="kn">import</span> <span class="n">cached</span>


<span class="c"># This is the XTC class. The TRR overrides with it&#39;s own.</span>
<div class="viewcode-block" id="Timestep"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.Timestep">[docs]</a><span class="k">class</span> <span class="nc">Timestep</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Timestep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Timestep for a Gromacs trajectory.</span>

<span class="sd">    .. versionchanged:: 0.11.0</span>
<span class="sd">       Attributes status, lmbda, prec all stored in the :attr:`data` dictionary</span>
<span class="sd">       Native frame number now stored as `_frame`, was `step`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Timestep</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">exdrOK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;prec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_init_unitcell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;unitcell dimensions (A, B, C, alpha, beta, gamma)</span>

<span class="sd">        - A, B, C are the lengths of the primitive cell vectors e1, e2, e3</span>
<span class="sd">        - alpha = angle(e1, e2)</span>
<span class="sd">        - beta = angle(e1, e3)</span>
<span class="sd">        - gamma = angle(e2, e3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Layout of unitcell is [X, Y, Z] with the primitive cell vectors</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">triclinic_box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="nd">@dimensions.setter</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">triclinic_vectors</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TrjWriter"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjWriter">[docs]</a><span class="k">class</span> <span class="nc">TrjWriter</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes to a Gromacs trajectory file</span>

<span class="sd">    (Base class)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: units of time (ps) and length (nm) in Gromacs</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;nm&#39;</span><span class="p">}</span>
    <span class="c">#: override to define trajectory format of the reader (XTC or TRR)</span>
    <span class="n">format</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">remarks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">convert_units</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new TrjWriter</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">             name of output file</span>
<span class="sd">          *n_atoms*</span>
<span class="sd">             number of atoms in trajectory file</span>

<span class="sd">        :Keywords:</span>
<span class="sd">          *start*</span>
<span class="sd">             starting timestep frame; only used when *dt* is set.</span>
<span class="sd">          *step*</span>
<span class="sd">             skip in frames between subsequent timesteps; only used when *dt* is set.</span>
<span class="sd">          *dt*</span>
<span class="sd">             time between frames to use. If set will override any time information</span>
<span class="sd">             contained in the passed :class:`Timestep` objects, which will otherwise</span>
<span class="sd">             be used.</span>
<span class="sd">             The :attr:`~Timestep.time` attribute defaults to a timestep of</span>
<span class="sd">             to setting the trajectory time at 1 ps per step if there is no</span>
<span class="sd">             time information.</span>
<span class="sd">          *precision*</span>
<span class="sd">              accuracy for lossy XTC format as a power of 10 (ignored</span>
<span class="sd">              for TRR) [1000.0]</span>
<span class="sd">          *convert_units*</span>
<span class="sd">             ``True``: units are converted to the MDAnalysis base format; ``None`` selects</span>
<span class="sd">             the value of :data:`MDAnalysis.core.flags` [&#39;convert_lengths&#39;].</span>
<span class="sd">             (see :ref:`flags-label`)</span>

<span class="sd">        .. versionchanged:: 0.8.0</span>
<span class="sd">           The TRR writer is now able to write TRRs without coordinates/velocities/forces,</span>
<span class="sd">           depending on the properties available in the :class:`Timestep` objects passed to</span>
<span class="sd">           :meth:`~TRRWriter.write`.</span>
<span class="sd">        .. versionchanged:: 0.11.0</span>
<span class="sd">           Keyword &quot;delta&quot; renamed to &quot;dt&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;TrjWriter: no atoms in output trajectory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c"># Convert filename to ascii because of SWIG bug.</span>
        <span class="c"># See: http://sourceforge.net/p/swig/feature-requests/75</span>
        <span class="c"># Only needed for Python &lt; 3</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">convert_units</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;convert_lengths&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">convert_units</span>  <span class="c"># convert length and time to base units on the fly?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="n">n_atoms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frames_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span> <span class="o">=</span> <span class="n">remarks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>  <span class="c"># only for XTC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdrfile_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># To flag empty properties to be skipped when writing a TRR it suffices to pass an empty 2D array with shape(</span>
        <span class="c"># natoms,0)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&#39;TRR&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_emptyarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="TrjWriter.write_next_timestep"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjWriter.write_next_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a new timestep to the trj file</span>

<span class="sd">        *ts* is a :class:`Timestep` instance containing coordinates to</span>
<span class="sd">        be written to trajectory file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Attempted to write to closed file </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;ts&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;TrjWriter: no coordinate data to write to trajectory file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">:</span>
            <span class="c"># Check to make sure Timestep has the correct number of atoms</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;TrjWriter: Timestep does not have the correct number of atoms&quot;</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_next_timestep</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">exdrOK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&quot;Error writing </span><span class="si">%s</span><span class="s"> file (status </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">status</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames_written</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
    <span class="k">def</span> <span class="nf">_write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic writer for XTC and TRR with minimum intelligence; override if necessary.&quot;&quot;&quot;</span>

        <span class="c"># (1) data common to XTC and TRR</span>

        <span class="c"># Time-writing logic: if the writer was created with a dt parameter,</span>
        <span class="c">#  use dt*(start+step*frames_written)</span>
        <span class="c">#  otherwise use the provided Timestep obj time attribute</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames_written</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_to_native</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># bogus, should be actual MD step number, i.e. frame * dt/delta</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span>

        <span class="n">unitcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dimensions_to_unitcell</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c"># must be float32 (!)</span>

        <span class="c"># make a copy of the scaled positions so that the in-memory</span>
        <span class="c"># timestep is not changed (would have lead to wrong results if</span>
        <span class="c"># analysed *after* writing a time step to disk). The new</span>
        <span class="c"># implementation could lead to memory problems and/or slow-down for</span>
        <span class="c"># very big systems because we temporarily create a new array pos</span>
        <span class="c"># for each frame written</span>
        <span class="c">#</span>
        <span class="c"># For TRR only go through the trouble if the frame actually has valid</span>
        <span class="c">#  coords/vels/forces; otherwise they won&#39;t be written anyway (pointers</span>
        <span class="c">#  set to an empty array that libxdrfile2.py knows it should set to NULL).</span>
        <span class="c">#</span>
        <span class="c"># (2) have to treat XTC and TRR somewhat differently</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&#39;XTC&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">write_xtc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">unitcell</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&#39;TRR&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lmbda</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;lmbda&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">lmbda</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c"># COORDINATES</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">has_positions</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emptyarr</span>
            <span class="c">#VELOCITIES</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                    <span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_velocities_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">velocities</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emptyarr</span>
            <span class="c"># FORCES</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                    <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_forces_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_forces</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">forces</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_forces</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emptyarr</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">write_trr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">lmbda</span><span class="p">,</span> <span class="n">unitcell</span><span class="p">,</span>
                                           <span class="n">pos</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">forces</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">exdrCLOSE</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdrfile_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">status</span>

<div class="viewcode-block" id="TrjWriter.convert_dimensions_to_unitcell"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjWriter.convert_dimensions_to_unitcell">[docs]</a>    <span class="k">def</span> <span class="nf">convert_dimensions_to_unitcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read dimensions from timestep *ts* and return Gromacs box vectors&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">triclinic_vectors</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="TrjReader"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader">[docs]</a><span class="k">class</span> <span class="nc">TrjReader</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic base class for reading Gromacs trajectories inside MDAnalysis.</span>

<span class="sd">    Derive classes and set :attr:`TrjReader.format`, :attr:`TrjReader._read_trj` and :attr:`TrjReader._read_trj_atoms`.</span>

<span class="sd">    Example::</span>
<span class="sd">       reader = TrjReader(&quot;file.trj&quot;)</span>
<span class="sd">       for ts in reader:</span>
<span class="sd">          print ts</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: units of time (ps) and length (nm) in Gromacs</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;nm&#39;</span><span class="p">}</span>
    <span class="c">#: override to define trajectory format of the reader (XTC or TRR)</span>
    <span class="n">format</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: supply the appropriate Timestep class, e.g.</span>
    <span class="c">#: :class:`MDAnalysis.coordinates.xdrfile.XTC.Timestep` for XTC</span>
    <span class="n">_Timestep</span> <span class="o">=</span> <span class="n">Timestep</span>
    <span class="c">#: writer class that matches this reader (override appropriately)</span>
    <span class="n">_Writer</span> <span class="o">=</span> <span class="n">TrjWriter</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :Arguments:</span>
<span class="sd">            *filename*</span>
<span class="sd">                the name of the trr file.</span>

<span class="sd">        :Keywords:</span>
<span class="sd">            *sub*</span>
<span class="sd">                an numpy integer array of what subset of trajectory atoms to load into</span>
<span class="sd">                the timestep. Intended to work similarly to the &#39;sub&#39; argument to Gromacs_&#39; trjconv.</span>

<span class="sd">                This is usefull when one has a Universe loaded with only an unsolvated protein, and</span>
<span class="sd">                wants to read a solvated trajectory.</span>

<span class="sd">                The length of this array must be &lt;= to the actual number of atoms in the trajectory, and</span>
<span class="sd">                equal to number of atoms in the Universe.</span>
<span class="sd">            *refresh_offsets*</span>
<span class="sd">                if ``True``, do not retrieve stored offsets, but instead generate</span>
<span class="sd">                new ones; if ``False``, use retrieved offsets if available [``False``]</span>

<span class="sd">        .. versionchanged:: 0.9.0</span>
<span class="sd">           New keyword *refresh_offsets*</span>
<span class="sd">        .. versionchanged:: 0.11.0</span>
<span class="sd">           Renamed &quot;delta&quot; attribute to &quot;dt&quot;</span>
<span class="sd">           Now passes weakref of self to ts (as &quot;_reader&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrjReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c"># Convert filename to ascii because of SWIG bug.</span>
        <span class="c"># See: http://sourceforge.net/p/swig/feature-requests/75</span>
        <span class="c"># Only needed for Python &lt; 3</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># takes a long time, avoid accessing self.n_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># compute from time in first two frames!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># storage of offsets in the file</span>

        <span class="c"># actual number of atoms in the trr file</span>
        <span class="c"># first time file is opened, exception should be thrown if bad file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trr_n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_natoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># logic for handling sub sections of trr:</span>
        <span class="c"># this class has some tmp buffers into which the libxdrfile2 functions read the</span>
        <span class="c"># entire frame, then this class copies the relevant sub section into the timestep.</span>
        <span class="c"># the sub section logic is contained entierly within this class.</span>

        <span class="c"># check to make sure sub is valid (if given)</span>
        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># only valid type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sub</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;sub MUST be a single dimensional numpy array of integers&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trr_n_atoms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;sub MUST be less than or equal to the number of actual trr atoms,&quot;</span>
                                 <span class="s">&quot; {0} in this case&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trr_n_atoms</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trr_n_atoms</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;sub contains out-of-range elements for the given trajectory&quot;</span><span class="p">)</span>
            <span class="c"># sub appears to be valid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sub</span> <span class="o">=</span> <span class="n">sub</span>

            <span class="c"># make tmp buffers</span>
            <span class="c"># C floats and C-order for arrays (see libxdrfile2.i)</span>
            <span class="n">DIM</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">DIM</span>  <span class="c"># compiled-in dimension (most likely 3)</span>
            <span class="c"># XTC and TRR allocate different things, so call this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allocate_sub</span><span class="p">(</span><span class="n">DIM</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sub</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_buf</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_velocities_buf</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_forces_buf</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># make the timestep, this is ALWAYS the used the public number of atoms</span>
        <span class="c"># (same as the calling Universe)</span>
        <span class="c"># at this time, _trr_n_atoms and _sub are set, so self.n_atoms has all it needs</span>
        <span class="c"># to determine number of atoms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># Read in the first timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>

        <span class="c"># try retrieving stored offsets</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;refresh_offsets&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_offsets</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of publically available atoms that this reader will store in the timestep.</span>

<span class="sd">        If &#39;sub&#39; was not given in the ctor, then this value will just be the actual</span>
<span class="sd">        number of atoms in the underlying trajectory file. If however &#39;sub&#39; was given, then</span>
<span class="sd">        this value is the number specified by the &#39;sub&#39; sub-selection.</span>

<span class="sd">        If for any reason the trajectory cannot be read then a negative value is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trr_n_atoms</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the number of frames from the trajectory.</span>

<span class="sd">        The result is cached. If for any reason the trajectory cannot</span>
<span class="sd">        be read then 0 is returned.</span>

<span class="sd">        This takes a long time because the frames are counted by</span>
<span class="sd">        iterating through the whole trajectory. If the trajectory</span>
<span class="sd">        was previously loaded and saved offsets exist, then</span>
<span class="sd">        loading will be significantly faster.</span>

<span class="sd">        .. SeeAlso:: :meth:`TrjReader.load_offsets` and :meth:`TrjReader.save_offsets`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># return cached value</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span>

    <span class="k">def</span> <span class="nf">_get_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time step length in ps.</span>

<span class="sd">        The result is computed from the trajectory and cached. If for</span>
<span class="sd">        any reason the trajectory cannot be read then 0 is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span>
        <span class="c"># no need for conversion: it&#39;s alread in our base unit ps</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">return</span> <span class="n">dt</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">curr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_offset_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;.{0}_offsets.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tail</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_store_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stores offsets for trajectory as a hidden file in the same directory</span>
<span class="sd">            as the trajectory itself.</span>

<span class="sd">        .. versionadded: 0.9.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># try to store offsets; if fails (due perhaps to permissions), then</span>
        <span class="c"># don&#39;t bother</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_offsets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_filename</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Offsets could not be stored; they will rebuilt when needed next.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_retrieve_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to retrieve previously autosaved offsets for trajectory.</span>

<span class="sd">        .. versionadded: 0.9.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_offsets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_filename</span><span class="p">(),</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Offsets could not be retrieved; they will be rebuilt instead.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TrjReader.save_offsets"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader.save_offsets">[docs]</a>    <span class="k">def</span> <span class="nf">save_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves current trajectory offsets into *filename*, as a pickled object.</span>

<span class="sd">        Along with the offsets themselves, the ctime and file size of the</span>
<span class="sd">        trajectory file are also saved.  These are used upon load as a check to</span>
<span class="sd">        ensure the offsets still match the trajectory they are being applied</span>
<span class="sd">        to.</span>

<span class="sd">        The offset file is a pickled dictionary with keys/values::</span>
<span class="sd">          *ctime*</span>
<span class="sd">             the ctime of the trajectory file</span>
<span class="sd">          *size*</span>
<span class="sd">             the size of the trajectory file</span>
<span class="sd">          *offsets*</span>
<span class="sd">             a numpy array of the offsets themselves</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">              filename in which to save the frame offsets</span>

<span class="sd">        .. versionadded: 0.8.0</span>
<span class="sd">        .. versionchanged: 0.9.0</span>
<span class="sd">           Format of the offsets file has changed. It is no longer a pickled numpy</span>
<span class="sd">           array, but now a pickled dictionary. See details above. Old offset files</span>
<span class="sd">           can no longer be loaded.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;ctime&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
                  <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
                  <span class="s">&#39;offsets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TrjReader.load_offsets"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader.load_offsets">[docs]</a>    <span class="k">def</span> <span class="nf">load_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads current trajectory offsets from pickled *filename*. </span>

<span class="sd">        Checks if ctime and size of trajectory file matches that stored in</span>
<span class="sd">        pickled *filename*.  If either one does not match (and *check* == ``True``)</span>
<span class="sd">        then the offsets are not loaded.  This is intended to conservatively</span>
<span class="sd">        avoid loading out-of-date offsets.</span>

<span class="sd">        The offset file is expected to be a pickled dictionary with keys/values::</span>
<span class="sd">          *ctime*</span>
<span class="sd">             the ctime of the trajectory file</span>
<span class="sd">          *size*</span>
<span class="sd">             the size of the trajectory file</span>
<span class="sd">          *offsets*</span>
<span class="sd">             a numpy array of the offsets themselves</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">              filename of pickle file saved with :meth:`~TrjReader.save_offsets` </span>
<span class="sd">              with the frame offsets for the loaded trajectory</span>

<span class="sd">        :Keywords:</span>
<span class="sd">          *check*</span>
<span class="sd">              if False, ignore ctime and size check of trajectory file</span>
<span class="sd">        </span>
<span class="sd">        :Raises: :exc:`IOError` if the file cannot be read (see :func:`open`).</span>

<span class="sd">        .. versionadded: 0.8.0</span>
<span class="sd">        .. versionchanged: 0.9.0</span>
<span class="sd">           Format of the offsets file has changed. It is no longer a pickled numpy</span>
<span class="sd">           array, but now a pickled dictionary. See details above. Old offset files</span>
<span class="sd">           can no longer be loaded.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>  <span class="c"># Return silently if the offset file is not present</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c">## ensure all conditions are met</span>
                <span class="c"># ctime of file must match that stored</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;ctime&#39;</span>
                <span class="n">conditions</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="c"># file size must also match</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;size&#39;</span>
                <span class="n">conditions</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">and</span> <span class="n">conditions</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Offsets in file &#39;{0}&#39; not suitable;&quot;</span>
                              <span class="s">&quot; missing {1}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="c"># if conditions not met, abort immediately</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Aborted loading offsets from file; ctime or size did not match.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># try to load offsets</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="s">&#39;offsets&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Missing key &#39;offsets&#39; in file &#39;{0}&#39;;&quot;</span>
                          <span class="s">&quot; aborting load of offsets.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">)</span>

        <span class="c"># finally, check that loaded offsets appear to work by trying</span>
        <span class="c"># to load last frame; otherwise, dump them so they get regenerated</span>
        <span class="c"># on next call to ``self.n_frames``</span>

        <span class="c">#store current frame</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># ensure we return to the frame we started with</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Could not access last frame with loaded offsets;&quot;</span>
                          <span class="s">&quot; will rebuild offsets instead.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="TrjReader.open_trajectory"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader.open_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">open_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open xdr trajectory file.</span>

<span class="sd">        :Returns: pointer to XDRFILE (and sets self.xdrfile)</span>
<span class="sd">        :Raises:  :exc:`IOError` with code EALREADY if file was already opened or</span>
<span class="sd">                  ENOENT if the file cannot be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EALREADY</span><span class="p">,</span> <span class="s">&#39;XDR file already opened&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="c"># must check; otherwise might segmentation fault</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s">&#39;XDR file not found&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdrfile_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="c"># reset ts</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">exdrOK</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
        <span class="n">ts</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># additional data for XTC</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;prec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># additional data for TRR</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;lmbda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span>
</div>
<div class="viewcode-block" id="TrjReader.close"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close xdr trajectory file if it was open.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdrfile_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># guard against  crashing with a double-free pointer</span>
</div>
<div class="viewcode-block" id="TrjReader.Writer"><a class="viewcode-back" href="../../../../documentation_pages/coordinates/xdrfile/core.html#MDAnalysis.coordinates.TRR.TrjReader.Writer">[docs]</a>    <span class="k">def</span> <span class="nf">Writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a Gromacs TrjWriter for *filename* with the same parameters as this trajectory.</span>

<span class="sd">        All values can be changed through keyword arguments.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">              filename of the output trajectory</span>

<span class="sd">        :Keywords:</span>
<span class="sd">          *n_atoms*</span>
<span class="sd">              number of atoms</span>
<span class="sd">          *dt*</span>
<span class="sd">              Time interval between frames.</span>
<span class="sd">          *precision*</span>
<span class="sd">              accuracy for lossy XTC format as a power of 10 (ignored</span>
<span class="sd">              for TRR) [1000.0]</span>

<span class="sd">        :Returns: appropriate :class:`TrjWriter`</span>

<span class="sd">        .. versionchanged:: 0.11.0</span>
<span class="sd">           Changed &quot;delta&quot; keyword to &quot;dt&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;n_atoms&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">/</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;precision&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c"># not needed for TRR</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Writer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reopen</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">ts</span>

    <span class="k">def</span> <span class="nf">_reopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trajectory</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fast, index-based, random frame access</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offsets</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># frame gets +1&#39;d in _read_next_timestep   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>

    <span class="c"># Renamed this once upon a time.</span>
    <span class="n">_goto_frame</span> <span class="o">=</span> <span class="n">_read_frame</span>

    <span class="k">def</span> <span class="nf">timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asel</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;afc&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;timeseries not available for Gromacs trajectories&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;correl not available for Gromacs trajectories&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Traj seeker&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdr_seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">,</span> <span class="nb">long</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdr_seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">,</span> <span class="nb">long</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">exdrOK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">,</span>
                          <span class="s">&quot;Problem seeking to offset </span><span class="si">%d</span><span class="s"> (relative to current = </span><span class="si">%s</span><span class="s">) on file </span><span class="si">%s</span><span class="s">, status </span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;Perhaps you are trying to read a file &gt;2GB and your system does not have large file&quot;</span>
                          <span class="s">&quot;support?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Traj pos getter&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">libxdrfile2</span><span class="o">.</span><span class="n">xdr_tell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdrfile</span><span class="p">)</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">MDAnalysis 0.11.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2005-2015, Naveen Michaud-Agrawal, Elizabeth J. Denning, Joshua Adelman,
    Christian Beckstein (logo), Alejandro Bernardin, Sbastien Buchoux,
    David Caplan, Matthieu Chavent, Xavier Deupi, Jan Domaski, David L. Dotson
    Lennard van der Feltz, Philip Fowler, Joseph Goose, Richard J. Gowers, Lukas Grossar,
    Benjamin Hall, Joe Jordan, Jinju Lu, Robert McGibbon, Alex Nesterenko,
    Manuel Nuno Melo, Caio S. Souza, Danny Parton, Joshua L. Phillips, Tyler Reddy,
    Paul Rigor, Sean L. Seyler, Andy Somogyi, Lukas Stelzl, Gorman Stock, Isaac Virshup,
    Zhuyi Xue, Carlos Yez S.,
    and Oliver Beckstein.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>