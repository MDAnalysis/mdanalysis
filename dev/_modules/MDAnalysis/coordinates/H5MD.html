


  
    
  




<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="shortcut icon" href="../../../_static/logo/mda_favicon.ico">
</head>

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDAnalysis.coordinates.H5MD &mdash; MDAnalysis 2.8.0-dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/site.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=a9b57af3"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/js/versions.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 2.8.0-dev0 documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >




  




<a href="../../../index.html">
  
    <img src="../../../_static/logo/mda_logo.png" class="logo" alt="Logo"/>
</a>


  
  
  
    <div class="version">
      2.8.0-dev0
    </div>
  



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div>
<div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
    <!-- <p class="caption" role="heading"></p> -->
    <ul>
        
        <li class="toctree-l1"><a class="reference internal" href="http://mdanalysis.org">MDAnalysis</a></li>
        
        <li class="toctree-l1"><a class="reference internal" href="http://userguide.mdanalysis.org">User guide</a></li>
        
        <li class="toctree-l1"><a class="reference internal" href="https://mdakits.mdanalysis.org/">MDAKits</a></li>
        
    </ul>
    
        <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/overview.html">1. Overview over MDAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology.html">2. The topology system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections.html">3. Selection commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/analysis_modules.html">4. Analysis modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology_modules.html">5. Topology modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/coordinates_modules.html">6. Coordinates modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/converters.html">7. Converter modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/trajectory_transformations.html">8. Trajectory transformations (“on-the-fly” transformations)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections_modules.html">9. Selection exporters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/auxiliary_modules.html">10. Auxiliary modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/core_modules.html">11. Core modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/visualization_modules.html">12. Visualization modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/lib_modules.html">13. Library functions — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.lib</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/version.html">14. Version information for MDAnalysis - <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.version</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/units.html">15. Constants and unit conversion — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.units</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/exceptions.html">16. Custom exceptions and warnings — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.exceptions</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/references.html">17. References</a></li>
</ul>

</div>

      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MDAnalysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">MDAnalysis.coordinates.H5MD</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MDAnalysis.coordinates.H5MD</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c1"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span>
<span class="c1">#</span>
<span class="c1"># MDAnalysis --- https://www.mdanalysis.org</span>
<span class="c1"># Copyright (c) 2006-2017 The MDAnalysis Development Team and contributors</span>
<span class="c1"># (see the file AUTHORS for the full list of names)</span>
<span class="c1">#</span>
<span class="c1"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c1">#</span>
<span class="c1"># Please cite your use of MDAnalysis in published work:</span>
<span class="c1">#</span>
<span class="c1"># R. J. Gowers, M. Linke, J. Barnoud, T. J. E. Reddy, M. N. Melo, S. L. Seyler,</span>
<span class="c1"># D. L. Dotson, J. Domanski, S. Buchoux, I. M. Kenney, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Python package for the rapid analysis of molecular dynamics</span>
<span class="c1"># simulations. In S. Benthall and S. Rostrup editors, Proceedings of the 15th</span>
<span class="c1"># Python in Science Conference, pages 102-109, Austin, TX, 2016. SciPy.</span>
<span class="c1"># doi: 10.25080/majora-629e541a-00e</span>
<span class="c1">#</span>
<span class="c1"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c1"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">H5MD trajectories --- :mod:`MDAnalysis.coordinates.H5MD`</span>
<span class="sd">========================================================</span>

<span class="sd">The `H5MD`_ trajectory file format is based upon the general, high performance</span>
<span class="sd">`HDF5`_ file format.</span>
<span class="sd">HDF5 files are self documenting and can be accessed with the `h5py`_ library.</span>
<span class="sd">HDF5 can make use of parallel file system features through the MPI-IO</span>
<span class="sd">interface of the HDF5 library to improve parallel reads and writes.</span>

<span class="sd">The HDF5 library and `h5py`_ must be installed; otherwise, H5MD files</span>
<span class="sd">cannot be read by MDAnalysis. If `h5py`_ is not installed, a</span>
<span class="sd">:exc:`RuntimeError` is raised.</span>

<span class="sd">Units</span>
<span class="sd">-----</span>

<span class="sd">H5MD files are very flexible and can store data in a wide range of physical</span>
<span class="sd">units. The :class:`H5MDReader` will attempt to match the units in order to</span>
<span class="sd">convert all data to the standard MDAnalysis units (see</span>
<span class="sd">:mod:`MDAnalysis.units`).</span>

<span class="sd">Units are read from the attributes of the position, velocity, force, and time</span>
<span class="sd">datasets provided by the H5MD file. The unit string is translated from `H5MD</span>
<span class="sd">notation`_ to `MDAnalysis notation`_. If MDAnalysis does not recognize the unit</span>
<span class="sd">(likely because that unit string is not defined in :mod:`MDAnalysis.units`)</span>
<span class="sd">provided, a :exc:`RuntimeError` is raised.  If no units are provided,</span>
<span class="sd">MDAnalysis stores a value of ``None`` for each unit.  If the H5MD file does not</span>
<span class="sd">contain units and ``convert_units=True``, MDAnalysis will raise a</span>
<span class="sd">:exc:`ValueError`. To load a universe from an H5MD file with no units defined,</span>
<span class="sd">set ``convert_units=False``.</span>

<span class="sd">:class:`H5MDWriter` detects the native units of the parent trajectory and</span>
<span class="sd">writes the trajectory with those units, unless one of `timeunit`,</span>
<span class="sd">`lengthunit`, `velocityunit`, `forceunit` arugments are supplied. In</span>
<span class="sd">this case, the writer will write the corresponding dataset with the selected</span>
<span class="sd">unit only if it is recognized by `MDAnalysis units`_.</span>


<span class="sd">Example: Loading an H5MD simulation</span>
<span class="sd">-----------------------------------</span>

<span class="sd">To load an H5MD simulation from an H5MD trajectory data file (using the</span>
<span class="sd">:class:`~MDAnalysis.coordinates.H5MD.H5MDReader`), pass the topology</span>
<span class="sd">and trajectory files to :class:`~MDAnalysis.core.universe.Universe`::</span>

<span class="sd">    import MDAnalysis as mda</span>
<span class="sd">    u = mda.Universe(&quot;topology.tpr&quot;, &quot;trajectory.h5md&quot;)</span>

<span class="sd">It is also possible to pass an open :class:`h5py.File` file stream</span>
<span class="sd">into the reader::</span>

<span class="sd">    import MDAnalysis as mda</span>
<span class="sd">    with h5py.File(&quot;trajectory.h5md&quot;, &#39;r&#39;) as f:</span>
<span class="sd">         u = mda.Universe(&quot;topology.tpr&quot;, f)</span>


<span class="sd">.. Note:: Directly using a `h5py.File` does not work yet.</span>
<span class="sd">   See issue `#2884 &lt;https://github.com/MDAnalysis/mdanalysis/issues/2884&gt;`_.</span>


<span class="sd">Example: Writing an H5MD file</span>
<span class="sd">-----------------------------</span>

<span class="sd">To write to an H5MD file from a trajectory loaded with MDAnalysis, do:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import MDAnalysis as mda</span>
<span class="sd">    u = mda.Universe(&quot;topology.tpr&quot;, &quot;trajectory.h5md&quot;)</span>
<span class="sd">    with mda.Writer(&quot;output.h5md&quot;, n_atoms=u.trajectory.n_atoms) as W:</span>
<span class="sd">        for ts in u.trajectory:</span>
<span class="sd">            W.write(u)</span>

<span class="sd">To write an H5MD file with contiguous datasets, you must specify the</span>
<span class="sd">number of frames to be written and set ``chunks=False``:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    with mda.Writer(&quot;output_contigous.h5md&quot;, n_atoms=u.trajectory.n_atoms,</span>
<span class="sd">                    n_frames=3, chunks=False) as W:</span>
<span class="sd">        for ts in u.trajectory[:3]:</span>
<span class="sd">            W.write(u)</span>

<span class="sd">The writer also supports writing directly from an :class:`~MDAnalysis.core.groups.AtomGroup`::</span>

<span class="sd">    ag = u.select_atoms(&quot;protein and name CA&quot;)</span>
<span class="sd">    ag.write(&quot;alpha_carbons.h5md&quot;, frames=&#39;all&#39;)</span>


<span class="sd">Example: Opening an H5MD file in parallel</span>
<span class="sd">-----------------------------------------</span>

<span class="sd">The parallel features of HDF5 can be accessed through h5py</span>
<span class="sd">(see `parallel h5py docs`_ for more detail) by using the `mpi4py`_ Python</span>
<span class="sd">package with a Parallel build of HDF5. To load a an H5MD simulation with</span>
<span class="sd">parallel HDF5, pass `driver` and `comm` arguments to</span>
<span class="sd">:class:`~MDAnalysis.core.universe.Universe`::</span>

<span class="sd">    import MDAnalysis as mda</span>
<span class="sd">    from mpi4py import MPI</span>
<span class="sd">    u = mda.Universe(&quot;topology.tpr&quot;, &quot;trajectory.h5md&quot;,</span>
<span class="sd">                     driver=&quot;mpio&quot;, comm=MPI.COMM_WORLD)</span>


<span class="sd">.. Note::</span>
<span class="sd">   :mod:`h5py` must be built with parallel features enabled on top of a parallel</span>
<span class="sd">   HDF5 build, and HDF5 and :mod:`mpi4py` must be built with a working MPI</span>
<span class="sd">   implementation. See instructions below.</span>

<span class="sd">Building parallel h5py and HDF5 on Linux</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">Building a working parallel HDF5/h5py/mpi4py environment can be</span>
<span class="sd">challenging and is often specific to your local computing resources,</span>
<span class="sd">e.g., the supercomputer that you&#39;re running on typically already has</span>
<span class="sd">its preferred MPI installation. As a starting point we provide</span>
<span class="sd">instructions that worked in a specific, fairly generic environment.</span>

<span class="sd">These instructions successfully built parallel HDF5/h5py</span>
<span class="sd">with *OpenMPI 4.0.4*, *HDF5 1.10.6*, *h5py 2.9.0*, and *mpi4py 3.0.3*</span>
<span class="sd">on *Ubuntu 16.0.6*. You may have to play around with different combinations of</span>
<span class="sd">versions of h5py/HDF5 to get a working parallel build.</span>

<span class="sd">    1. `Build MPI from sources`_</span>
<span class="sd">    2. `Build HDF5 from sources`_ with parallel settings enabled:</span>

<span class="sd">       .. code-block:: bash</span>

<span class="sd">          ./configure --enable-parallel --enable-shared</span>
<span class="sd">          make</span>
<span class="sd">          make install</span>

<span class="sd">    3. `Install mpi4py`_, making sure to point `mpicc` to where you&#39;ve</span>
<span class="sd">       installed your MPI implemenation:</span>

<span class="sd">       .. code-block:: bash</span>

<span class="sd">          env MPICC=/path/to/mpicc pip install mpi4py</span>

<span class="sd">    4. `Build h5py from sources`_, making sure to enable mpi and to point</span>
<span class="sd">       to your parallel build of HDF5:</span>

<span class="sd">       .. code-block:: bash</span>

<span class="sd">          export HDF5_PATH=path-to-parallel-hdf5</span>
<span class="sd">          python setup.py clean --all</span>
<span class="sd">          python setup.py configure -r --hdf5-version=X.Y.Z --mpi --hdf5=$HDF5_PATH</span>
<span class="sd">          export gcc=gcc</span>
<span class="sd">          CC=mpicc HDF5_DIR=$HDF5_PATH python setup.py build</span>
<span class="sd">          python setup.py install</span>

<span class="sd">If you have questions or want to share how you managed to build</span>
<span class="sd">parallel hdf5/h5py/mpi4py please let everyone know on the</span>
<span class="sd">`MDAnalysis forums`_.</span>

<span class="sd">.. _`H5MD`: https://nongnu.org/h5md/index.html</span>
<span class="sd">.. _`HDF5`: https://www.hdfgroup.org/solutions/hdf5/</span>
<span class="sd">.. _`H5PY`: http://docs.h5py.org/</span>
<span class="sd">.. _`parallel h5py docs`: https://docs.h5py.org/en/stable/mpi.html</span>
<span class="sd">.. _`mpi4py`: https://mpi4py.readthedocs.io/en/stable/index.html</span>
<span class="sd">.. _`Build MPI from sources`: https://mpi4py.readthedocs.io/en/stable/appendix.html#building-mpi-from-sources</span>
<span class="sd">.. _`Build HDF5 from sources`: https://support.hdfgroup.org/ftp/HDF5/current/src/unpacked/release_docs/INSTALL_parallel</span>
<span class="sd">.. _`Install mpi4py`: https://mpi4py.readthedocs.io/en/stable/install.html#requirements</span>
<span class="sd">.. _`Build h5py from sources`: https://docs.h5py.org/en/stable/mpi.html#building-against-parallel-hdf5</span>
<span class="sd">.. _`H5MD notation`: https://nongnu.org/h5md/modules/units.html</span>
<span class="sd">.. _`MDAnalysis notation`: https://userguide.mdanalysis.org/units.html</span>
<span class="sd">.. _`MDAnalysis units`: https://userguide.mdanalysis.org/units.html</span>
<span class="sd">.. _`MDAnalysis forums`: https://www.mdanalysis.org/#participating</span>


<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. autoclass:: H5MDReader</span>
<span class="sd">   :members:</span>
<span class="sd">   :inherited-members:</span>

<span class="sd">   .. automethod:: H5MDReader._reopen</span>

<span class="sd">.. autoclass:: H5MDWriter</span>
<span class="sd">   :members:</span>
<span class="sd">   :inherited-members:</span>

<span class="sd">.. autoclass:: H5PYPicklable</span>
<span class="sd">   :members:</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span><span class="p">,</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NoDataError</span>
<span class="kn">from</span> <span class="nn">..due</span> <span class="kn">import</span> <span class="n">due</span><span class="p">,</span> <span class="n">Doi</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.lib.util</span> <span class="kn">import</span> <span class="n">store_init_arguments</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_H5PY</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Allow building documentation even if h5py is not installed</span>
    <span class="kn">import</span> <span class="nn">types</span>

    <span class="k">class</span> <span class="nc">MockH5pyFile</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">h5py</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;h5py&quot;</span><span class="p">)</span>
    <span class="n">h5py</span><span class="o">.</span><span class="n">File</span> <span class="o">=</span> <span class="n">MockH5pyFile</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">HAS_H5PY</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="H5MDReader">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader">[docs]</a>
<span class="k">class</span> <span class="nc">H5MDReader</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">ReaderBase</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Reader for the H5MD format.</span>

<span class="sd">    See `h5md documentation &lt;https://nongnu.org/h5md/h5md.html&gt;`_</span>
<span class="sd">    for a detailed overview of the H5MD file format.</span>

<span class="sd">    The reader attempts to convert units in the trajectory file to</span>
<span class="sd">    the standard MDAnalysis units (:mod:`MDAnalysis.units`) if</span>
<span class="sd">    `convert_units` is set to ``True``.</span>

<span class="sd">    Additional data in the *observables* group of the H5MD file are</span>
<span class="sd">    loaded into the :attr:`Timestep.data</span>
<span class="sd">    &lt;MDAnalysis.coordinates.timestep.Timestep.data&gt;` dictionary.</span>

<span class="sd">    Only 3D-periodic boxes or no periodicity are supported; for no</span>
<span class="sd">    periodicity, :attr:`Timestep.dimensions</span>
<span class="sd">    &lt;MDAnalysis.coordinates.timestep.Timestep.dimensions&gt;` will return ``None``.</span>

<span class="sd">    Although H5MD can store varying numbers of particles per time step</span>
<span class="sd">    as produced by, e.g., GCMC simulations, MDAnalysis can currently</span>
<span class="sd">    only process a fixed number of particles per step. If the number</span>
<span class="sd">    of particles changes a :exc:`ValueError` is raised.</span>

<span class="sd">    The :class:`H5MDReader` reads .h5md files with the following</span>
<span class="sd">    HDF5 hierarchy:</span>

<span class="sd">    .. code-block:: text</span>

<span class="sd">        Notation:</span>
<span class="sd">        (name) is an HDF5 group that the reader recognizes</span>
<span class="sd">        {name} is an HDF5 group with arbitrary name</span>
<span class="sd">        [variable] is an HDF5 dataset</span>
<span class="sd">        &lt;dtype&gt; is dataset datatype</span>
<span class="sd">        +-- is an attribute of a group or dataset</span>

<span class="sd">        H5MD root</span>
<span class="sd">         \-- (h5md)</span>
<span class="sd">            +-- version &lt;int&gt;</span>
<span class="sd">            \-- author</span>
<span class="sd">                +-- name &lt;str&gt;, author&#39;s name</span>
<span class="sd">                +-- email &lt;str&gt;, optional email address</span>
<span class="sd">            \-- creator</span>
<span class="sd">                +-- name &lt;str&gt;, file that created .h5md file</span>
<span class="sd">                +-- version</span>
<span class="sd">         \-- (particles)</span>
<span class="sd">            \-- {group1}</span>
<span class="sd">                \-- (box)</span>
<span class="sd">                    +-- dimension : &lt;int&gt;, number of spatial dimensions</span>
<span class="sd">                    +-- boundary : &lt;str&gt;, boundary conditions of unit cell</span>
<span class="sd">                    \-- (edges)</span>
<span class="sd">                        \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                        \-- [value] &lt;float&gt;, gives box dimensions</span>
<span class="sd">                            +-- unit &lt;str&gt;</span>
<span class="sd">                \-- (position)</span>
<span class="sd">                    \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                    \-- [time] &lt;float&gt;, gives time</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">                    \-- [value] &lt;float&gt;, gives numpy arrary of positions</span>
<span class="sd">                                         with shape (n_atoms, 3)</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">                \-- (velocity)</span>
<span class="sd">                    \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                    \-- [time] &lt;float&gt;, gives time</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">                    \-- [value] &lt;float&gt;, gives numpy arrary of velocities</span>
<span class="sd">                                         with shape (n_atoms, 3)</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">                \-- (force)</span>
<span class="sd">                    \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                    \-- [time] &lt;float&gt;, gives time</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">                    \-- [value] &lt;float&gt;, gives numpy arrary of forces</span>
<span class="sd">                                         with shape (n_atoms, 3)</span>
<span class="sd">                        +-- unit &lt;str&gt;</span>
<span class="sd">         \-- (observables)</span>
<span class="sd">            \-- (lambda)</span>
<span class="sd">                \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                \-- [time] &lt;float&gt;, gives time</span>
<span class="sd">                \-- [value] &lt;float&gt;</span>
<span class="sd">            \-- (step)</span>
<span class="sd">                \-- [step] &lt;int&gt;, gives frame</span>
<span class="sd">                \-- [time] &lt;float&gt;, gives time</span>
<span class="sd">                \-- [value] &lt;int&gt;, gives integration step</span>


<span class="sd">    .. note::</span>
<span class="sd">        The reader does not currently read mass or charge data.</span>

<span class="sd">    .. note::</span>
<span class="sd">        If the `driver` and `comm` arguments were used to open the</span>
<span class="sd">        hdf5 file (specifically, ``driver=&quot;mpio&quot;``) then the :meth:`_reopen`</span>
<span class="sd">        method does *not* close and open the file like most readers because</span>
<span class="sd">        the information about the MPI communicator would be lost; instead</span>
<span class="sd">        it rewinds the trajectory back to the first timestep.</span>


<span class="sd">    .. versionadded:: 2.0.0</span>
<span class="sd">    .. versionchanged:: 2.1.0</span>
<span class="sd">       Adds :meth:`parse_n_atoms` method to obtain the number of atoms directly</span>
<span class="sd">       from the trajectory by evaluating the shape of the ``position``,</span>
<span class="sd">       ``velocity``, or ``force`` groups.</span>
<span class="sd">    .. versionchanged:: 2.5.0</span>
<span class="sd">       Add correct handling of simple cuboid boxes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;H5MD&#39;</span>
    <span class="c1"># units is defined as instance-level variable and set from the</span>
    <span class="c1"># H5MD file in __init__() below</span>

    <span class="c1"># This dictionary is used to translate H5MD units to MDAnalysis units.</span>
    <span class="c1"># (https://nongnu.org/h5md/modules/units.html)</span>
    <span class="n">_unit_translation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sec&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AKMA&#39;</span><span class="p">:</span> <span class="s1">&#39;AKMA&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Angstrom&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;angstrom&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm&#39;</span><span class="p">:</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pm&#39;</span><span class="p">:</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="s1">&#39;fm&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Angstrom ps-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A ps-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Angstrom fs-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/fs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A fs-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/fs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Angstrom AKMA-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/AKMA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A AKMA-1&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom/AKMA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm ps-1&#39;</span><span class="p">:</span> <span class="s1">&#39;nm/ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm ns-1&#39;</span><span class="p">:</span> <span class="s1">&#39;nm/ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pm ps-1&#39;</span><span class="p">:</span> <span class="s1">&#39;pm/ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m s-1&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;force&#39;</span><span class="p">:</span>  <span class="p">{</span>
            <span class="s1">&#39;kJ mol-1 Angstrom-1&#39;</span><span class="p">:</span> <span class="s1">&#39;kJ/(mol*Angstrom)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kJ mol-1 nm-1&#39;</span><span class="p">:</span> <span class="s1">&#39;kJ/(mol*nm)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Newton&#39;</span><span class="p">:</span> <span class="s1">&#39;Newton&#39;</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
            <span class="s1">&#39;J m-1&#39;</span><span class="p">:</span> <span class="s1">&#39;J/m&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kcal mol-1 Angstrom-1&#39;</span><span class="p">:</span> <span class="s1">&#39;kcal/(mol*Angstrom)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kcal mol-1 A-1&#39;</span><span class="p">:</span> <span class="s1">&#39;kcal/(mol*Angstrom)&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span><span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.25080/majora-1b6fd038-005&quot;</span><span class="p">),</span>
               <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MDAnalysis trajectory reader/writer of the H5MD&quot;</span>
               <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span><span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1016/j.cpc.2014.01.018&quot;</span><span class="p">),</span>
               <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Specifications of the H5MD standard&quot;</span><span class="p">,</span>
               <span class="n">path</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="p">)</span>
    <span class="nd">@store_init_arguments</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                 <span class="n">convert_units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str or :class:`h5py.File`</span>
<span class="sd">            trajectory filename or open h5py file</span>
<span class="sd">        convert_units : bool (optional)</span>
<span class="sd">            convert units to MDAnalysis units</span>
<span class="sd">        driver : str (optional)</span>
<span class="sd">            H5PY file driver used to open H5MD file</span>
<span class="sd">        comm : :class:`MPI.Comm` (optional)</span>
<span class="sd">            MPI communicator used to open H5MD file</span>
<span class="sd">            Must be passed with `&#39;mpio&#39;` file driver</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            General reader arguments.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            when `H5PY`_ is not installed</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            when a unit is not recognized by MDAnalysis</span>
<span class="sd">        ValueError</span>
<span class="sd">            when ``n_atoms`` changes values between timesteps</span>
<span class="sd">        ValueError</span>
<span class="sd">            when ``convert_units=True`` but the H5MD file contains no units</span>
<span class="sd">        ValueError</span>
<span class="sd">            when dimension of unitcell is not 3</span>
<span class="sd">        ValueError</span>
<span class="sd">            when an MPI communicator object is passed to the reader</span>
<span class="sd">            but ``driver != &#39;mpio&#39;``</span>
<span class="sd">        NoDataError</span>
<span class="sd">            when the H5MD file has no &#39;position&#39;, &#39;velocity&#39;, or</span>
<span class="sd">            &#39;force&#39; group</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_H5PY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please install h5py&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">H5MDReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">convert_units</span>

        <span class="c1"># if comm is provided, driver must be &#39;mpio&#39; and file will be</span>
        <span class="c1"># opened with parallel h5py/hdf5 enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">driver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="n">comm</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">!=</span> <span class="s1">&#39;mpio&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If MPI communicator object is used to open&quot;</span>
                             <span class="s2">&quot; h5md file, ``driver=&#39;mpio&#39;`` must be passed.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_trajectory</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MDAnalysis only supports 3-dimensional&quot;</span>
                             <span class="s2">&quot; simulation boxes&quot;</span><span class="p">)</span>

        <span class="c1"># _has dictionary used for checking whether h5md file has</span>
        <span class="c1"># &#39;position&#39;, &#39;velocity&#39;, or &#39;force&#39; groups in the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span> <span class="k">for</span>
                     <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">)}</span>

        <span class="c1"># Gets some info about what settings the datasets were created with</span>
        <span class="c1"># from first available group</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">compression</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compression_opts</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">compression_opts</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoDataError</span><span class="p">(</span><span class="s2">&quot;Provide at least a position, velocity&quot;</span>
                              <span class="s2">&quot; or force group in the h5md file.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span>
                                 <span class="n">positions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_positions</span><span class="p">,</span>
                                 <span class="n">velocities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">,</span>
                                 <span class="n">forces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">,</span>
                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_translated_units</span><span class="p">()</span>  <span class="c1"># fills units dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_translated_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;converts units from H5MD to MDAnalysis notation</span>
<span class="sd">        and fills units dictionary&quot;&quot;&quot;</span>

        <span class="c1"># need this dictionary to associate &#39;position&#39;: &#39;length&#39;</span>
        <span class="n">_group_unit_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="s1">&#39;force&#39;</span>
                            <span class="p">}</span>

        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">_group_unit_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_translate_h5md_units</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_units</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_translate_h5md_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;stores the translated unit string into the units dictionary&quot;&quot;&quot;</span>

        <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> unit &#39;</span><span class="si">{}</span><span class="s2">&#39; is not recognized by H5MDReader. Please raise&quot;</span>
        <span class="s2">&quot; an issue in https://github.com/MDAnalysis/mdanalysis/issues&quot;</span>

        <span class="c1"># doing time unit separately because time has to fish for</span>
        <span class="c1"># first available parent group - either position, velocity, or force</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation</span><span class="p">[</span>
                                <span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span>
                                    <span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]]</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                               <span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span>
                                               <span class="n">name</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">])</span>
                                               <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation</span><span class="p">[</span><span class="n">unit</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                           <span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">group</span><span class="p">][</span>
                                           <span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">])</span>
                                           <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

            <span class="c1"># if position group is not provided, can still get &#39;length&#39; unit</span>
            <span class="c1"># from unitcell box</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="s1">&#39;box/edges/value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation</span><span class="p">[</span>
                                               <span class="s1">&#39;length&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span>
                                               <span class="s1">&#39;box/edges/value&#39;</span>
                                               <span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span>
                                           <span class="s1">&#39;box/edges/value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span>
                                           <span class="s1">&#39;unit&#39;</span><span class="p">]))</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raises error if no units are provided from H5MD file</span>
<span class="sd">        and convert_units=True&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;H5MD file must have readable units if ``convert_units`` is&quot;</span>
        <span class="s2">&quot; set to ``True``. MDAnalysis sets ``convert_units=True`` by default.&quot;</span>
        <span class="s2">&quot; Set ``convert_units=False`` to load Universe without units.&quot;</span>

        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_hint</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Can this Reader read *thing*&quot;&quot;&quot;</span>
        <span class="c1"># nb, filename strings can still get passed through if</span>
        <span class="c1"># format=&#39;H5MD&#39; is used</span>
        <span class="k">return</span> <span class="n">HAS_H5PY</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span>

<div class="viewcode-block" id="H5MDReader.parse_n_atoms">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader.parse_n_atoms">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_n_atoms</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;particles/trajectory&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">):</span>
                    <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;particles/trajectory/</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">n_atoms</span>

            <span class="k">raise</span> <span class="n">NoDataError</span><span class="p">(</span><span class="s2">&quot;Could not construct minimal topology from the &quot;</span>
                              <span class="s2">&quot;H5MD trajectory file, as it did not contain a &quot;</span>
                              <span class="s2">&quot;&#39;position&#39;, &#39;velocity&#39;, or &#39;force&#39; group. &quot;</span>
                              <span class="s2">&quot;You must include a topology file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="H5MDReader.open_trajectory">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader.open_trajectory">[docs]</a>
    <span class="k">def</span> <span class="nf">open_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;opens the trajectory file using h5py library&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">driver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># can only pass comm argument to h5py.File if driver=&#39;mpio&#39;</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">==</span> <span class="s1">&#39;mpio&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">H5PYPicklable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>  <span class="c1"># pragma: no cover</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                                           <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">,</span>
                                           <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">H5PYPicklable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                                           <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">)</span>

        <span class="c1"># pulls first key out of &#39;particles&#39;</span>
        <span class="c1"># allows for arbitrary name of group1 in &#39;particles&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">][</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;number of frames in trajectory&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;reads data from h5md file and copies to current timestep&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoDataError</span><span class="p">(</span><span class="s2">&quot;Provide at least a position, velocity&quot;</span>
                                  <span class="s2">&quot; or force group in the h5md file.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="n">particle_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>

        <span class="c1"># fills data dictionary from &#39;observables&#39; group</span>
        <span class="c1"># Note: dt is not read into data as it is not decided whether</span>
        <span class="c1"># Timestep should have a dt attribute (see Issue #2825)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_to_data</span><span class="p">()</span>

        <span class="c1"># Sets frame box dimensions</span>
        <span class="c1"># Note: H5MD files must contain &#39;box&#39; group in each &#39;particles&#39; group</span>
        <span class="k">if</span> <span class="s2">&quot;edges&quot;</span> <span class="ow">in</span> <span class="n">particle_group</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">]:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">particle_group</span><span class="p">[</span><span class="s2">&quot;box/edges/value&quot;</span><span class="p">][</span><span class="n">frame</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># A D-dimensional vector or a D × D matrix, depending on the</span>
            <span class="c1"># geometry of the box, of Float or Integer type. If edges is a</span>
            <span class="c1"># vector, it specifies the space diagonal of a cuboid-shaped box.</span>
            <span class="c1"># If edges is a matrix, the box is of triclinic shape with the edge</span>
            <span class="c1"># vectors given by the rows of the matrix.</span>
            <span class="k">if</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">edges</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">triclinic_box</span><span class="p">(</span><span class="o">*</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set the timestep positions, velocities, and forces with</span>
        <span class="c1"># current frame dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataset_into_ts</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataset_into_ts</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataset_into_ts</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">forces</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_units</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">def</span> <span class="nf">_copy_to_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;assigns values to keys in data dictionary&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;observables&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;observables&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># if has value as subkey read directly into data</span>
                    <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;observables&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;observables&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span>
                            <span class="s2">&quot;value&quot;</span>
                        <span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">]</span>
                    <span class="c1"># if value is not a subkey, read dict of subkeys</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;observables&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span>
                                <span class="s2">&quot;observables&quot;</span>
                            <span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="c1"># KeyError: subkey is a dataset, but does not have &#39;value&#39;</span>
                    <span class="c1"># AttributeError: key is a group, not a dataset</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not read </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> from observables group. &quot;</span>
                        <span class="s2">&quot;Possibly not a legal H5MD observable specification.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># pulls &#39;time&#39; and &#39;step&#39; out of first available parent group</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span>
                        <span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="n">name</span><span class="p">][</span>
                        <span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">]</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_read_dataset_into_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;reads position, velocity, or force dataset array at current frame</span>
<span class="sd">        into corresponding ts attribute&quot;&quot;&quot;</span>

        <span class="n">n_atoms_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">][</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_atoms_now</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="si">}</span><span class="s2"> of the </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2"> dataset&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; has </span><span class="si">{</span><span class="n">n_atoms_now</span><span class="si">}</span><span class="s2"> atoms but the initial frame&quot;</span>
                             <span class="s2">&quot; of either the postion, velocity, or force&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; dataset had </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="si">}</span><span class="s2"> atoms.&quot;</span>
                             <span class="s2">&quot; MDAnalysis is unable to deal&quot;</span>
                             <span class="s2">&quot; with variable topology!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read_direct</span><span class="p">(</span>
                             <span class="n">attribute</span><span class="p">,</span> <span class="n">source_sel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">def</span> <span class="nf">_convert_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;converts time, position, velocity, and force values if they</span>
<span class="sd">        are not given in MDAnalysis standard units</span>

<span class="sd">        See https://userguide.mdanalysis.org/1.0.0/units.html</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_velocities_from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_forces_from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">forces</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;read next frame in trajectory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="H5MDReader.close">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;close reader&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="H5MDReader._reopen">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader._reopen">[docs]</a>
    <span class="k">def</span> <span class="nf">_reopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;reopen trajectory</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>

<span class="sd">        If the `driver` and `comm` arguments were used to open the</span>
<span class="sd">        hdf5 file (specifically, ``driver=&quot;mpio&quot;``) then this method</span>
<span class="sd">        does *not* close and open the file like most readers because</span>
<span class="sd">        the information about the MPI communicator would be lost; instead</span>
<span class="sd">        it rewinds the trajectory back to the first timstep.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">==</span> <span class="s2">&quot;mpio&quot;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trajectory</span><span class="p">()</span></div>


<div class="viewcode-block" id="H5MDReader.Writer">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDReader.Writer">[docs]</a>
    <span class="k">def</span> <span class="nf">Writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">n_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return writer for trajectory format</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        The chunk shape of the input file will not be copied to the output</span>
<span class="sd">        file, as :class:`H5MDWriter` uses a chunk shape of ``(1, n_atoms, 3)``</span>
<span class="sd">        by default. To use a custom chunk shape, you must specify the</span>
<span class="sd">        `chunks` argument. If you would like to copy an existing chunk</span>
<span class="sd">        format from a dataset (positions, velocities, or forces), do</span>
<span class="sd">        the following::</span>

<span class="sd">            chunks = u.trajectory._particle_group[&#39;position/value&#39;].chunks</span>

<span class="sd">        Note that the writer will set the same layout for all particle groups.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`H5MDWriter`  Output class for the H5MD format</span>


<span class="sd">        .. versionadded:: 2.0.0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;compression&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;compression_opts&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression_opts</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_positions</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;velocities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;forces&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">H5MDWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if &#39;position&#39; group is in trajectory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

    <span class="nd">@has_positions</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">has_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if &#39;velocity&#39; group is in trajectory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>

    <span class="nd">@has_velocities</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">has_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if &#39;force&#39; group is in trajectory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span>

    <span class="nd">@has_forces</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">has_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;_particle_group&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">][</span>
                               <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span></div>



<div class="viewcode-block" id="H5MDWriter">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5MDWriter">[docs]</a>
<span class="k">class</span> <span class="nc">H5MDWriter</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">WriterBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writer for `H5MD`_ format (version 1.1).</span>

<span class="sd">    H5MD trajectories are automatically recognised by the</span>
<span class="sd">    file extension &quot;.h5md&quot;.</span>

<span class="sd">    All data from the input :class:`~MDAnalysis.coordinates.timestep.Timestep` is</span>
<span class="sd">    written by default. For detailed information on how :class:`H5MDWriter`</span>
<span class="sd">    handles units, compression, and chunking, see the Notes section below.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Parellel writing with the use of a MPI communicator and the ``&#39;mpio&#39;``</span>
<span class="sd">    HDF5 driver is currently not supported.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    :exc:`NoDataError` is raised if no positions, velocities, or forces are</span>
<span class="sd">    found in the input trajectory. While the H5MD standard allows for this</span>
<span class="sd">    case, :class:`H5MDReader` cannot currently read files without at least</span>
<span class="sd">    one of these three groups.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Writing H5MD files with fancy trajectory slicing where the Timestep</span>
<span class="sd">    does not increase monotonically such as ``u.trajectory[[2,1,0]]``</span>
<span class="sd">    or ``u.trajectory[[0,1,2,0,1,2]]`` raises a :exc:`ValueError` as this</span>
<span class="sd">    violates the rules of the step dataset in the H5MD standard.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str or :class:`h5py.File`</span>
<span class="sd">        trajectory filename or open h5py file</span>
<span class="sd">    n_atoms : int</span>
<span class="sd">        number of atoms in trajectory</span>
<span class="sd">    n_frames : int (optional)</span>
<span class="sd">        number of frames to be written in trajectory</span>
<span class="sd">    driver : str (optional)</span>
<span class="sd">        H5PY file driver used to open H5MD file. See `H5PY drivers`_ for</span>
<span class="sd">        list of available drivers.</span>
<span class="sd">    convert_units : bool (optional)</span>
<span class="sd">        Convert units from MDAnalysis to desired units</span>
<span class="sd">    chunks : tuple (optional)</span>
<span class="sd">        Custom chunk layout to be applied to the position,</span>
<span class="sd">        velocity, and force datasets. By default, these datasets</span>
<span class="sd">        are chunked in ``(1, n_atoms, 3)`` blocks</span>
<span class="sd">    compression : str or int (optional)</span>
<span class="sd">        HDF5 dataset compression setting to be applied</span>
<span class="sd">        to position, velocity, and force datasets. Allowed</span>
<span class="sd">        settings are &#39;gzip&#39;, &#39;szip&#39;, &#39;lzf&#39;. If an integer</span>
<span class="sd">        in range(10), this indicates gzip compression level.</span>
<span class="sd">        Otherwise, an integer indicates the number of a</span>
<span class="sd">        dynamically loaded compression filter.</span>
<span class="sd">    compression_opts : int or tup (optional)</span>
<span class="sd">        Compression settings.  This is an integer for gzip, 2-tuple for</span>
<span class="sd">        szip, etc. If specifying a dynamically loaded compression filter</span>
<span class="sd">        number, this must be a tuple of values. For gzip, 1 indicates</span>
<span class="sd">        the lowest level of compression and 9 indicates maximum compression.</span>
<span class="sd">    positions : bool (optional)</span>
<span class="sd">        Write positions into the trajectory [``True``]</span>
<span class="sd">    velocities : bool (optional)</span>
<span class="sd">        Write velocities into the trajectory [``True``]</span>
<span class="sd">    forces : bool (optional)</span>
<span class="sd">        Write forces into the trajectory [``True``]</span>
<span class="sd">    timeunit : str (optional)</span>
<span class="sd">        Option to convert values in the &#39;time&#39; dataset to a custom unit,</span>
<span class="sd">        must be recognizable by MDAnalysis</span>
<span class="sd">    lengthunit : str (optional)</span>
<span class="sd">        Option to convert values in the &#39;position/value&#39; dataset to a</span>
<span class="sd">        custom unit, must be recognizable by MDAnalysis</span>
<span class="sd">    velocityunit : str (optional)</span>
<span class="sd">        Option to convert values in the &#39;velocity/value&#39; dataset to a</span>
<span class="sd">        custom unit, must be recognizable by MDAnalysis</span>
<span class="sd">    forceunit : str (optional)</span>
<span class="sd">        Option to convert values in the &#39;force/value&#39; dataset to a</span>
<span class="sd">        custom unit, must be recognizable by MDAnalysis</span>
<span class="sd">    author : str (optional)</span>
<span class="sd">        Name of the author of the file</span>
<span class="sd">    author_email : str (optional)</span>
<span class="sd">        Email of the author of the file</span>
<span class="sd">    creator : str (optional)</span>
<span class="sd">        Software that wrote the file [``MDAnalysis``]</span>
<span class="sd">    creator_version : str (optional)</span>
<span class="sd">        Version of software that wrote the file</span>
<span class="sd">        [:attr:`MDAnalysis.__version__`]</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        when `H5PY`_ is not installed</span>
<span class="sd">    ValueError</span>
<span class="sd">        when `n_atoms` is 0</span>
<span class="sd">    ValueError</span>
<span class="sd">        when ``chunks=False`` but the user did not specify `n_frames`</span>
<span class="sd">    ValueError</span>
<span class="sd">        when `positions`, `velocities`, and `forces` are all</span>
<span class="sd">        set to ``False``</span>
<span class="sd">    TypeError</span>
<span class="sd">        when the input object is not a :class:`Universe` or</span>
<span class="sd">        :class:`AtomGroup`</span>
<span class="sd">    IOError</span>
<span class="sd">        when `n_atoms` of the :class:`Universe` or :class:`AtomGroup`</span>
<span class="sd">        being written does not match `n_atoms` passed as an argument</span>
<span class="sd">        to the writer</span>
<span class="sd">    ValueError</span>
<span class="sd">        when any of the optional `timeunit`, `lengthunit`,</span>
<span class="sd">        `velocityunit`, or `forceunit` keyword arguments are</span>
<span class="sd">        not recognized by MDAnalysis</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    By default, the writer will write all available data (positions,</span>
<span class="sd">    velocities, and forces) if detected in the input</span>
<span class="sd">    :class:`~MDAnalysis.coordinates.timestep.Timestep`. In addition, the settings</span>
<span class="sd">    for `compression` and `compression_opts` will be read from</span>
<span class="sd">    the first available group of positions, velocities, or forces and used as</span>
<span class="sd">    the default value. To write a file without any one of these datsets,</span>
<span class="sd">    set `positions`, `velocities`, or `forces` to ``False``.</span>

<span class="sd">    .. rubric:: Units</span>

<span class="sd">    The H5MD format is very flexible with regards to units, as there is no</span>
<span class="sd">    standard defined unit for the format. For this reason, :class:`H5MDWriter`</span>
<span class="sd">    does not enforce any units. The units of the written trajectory can be set</span>
<span class="sd">    explicitly with the keyword arguments `lengthunit`, `velocityunit`,</span>
<span class="sd">    and `forceunit`. If units are not explicitly specified, they are set to</span>
<span class="sd">    the native units of the trajectory that is the source of the coordinates.</span>
<span class="sd">    For example, if one converts a DCD trajectory, then positions are written</span>
<span class="sd">    in ångstrom and time in AKMA units. A GROMACS XTC will be written in nm and</span>
<span class="sd">    ps. The units are stored in the metadata of the H5MD file so when</span>
<span class="sd">    MDAnalysis loads the H5MD trajectory, the units will be automatically</span>
<span class="sd">    set correctly.</span>

<span class="sd">    .. rubric:: Compression</span>

<span class="sd">    HDF5 natively supports various compression modes. To write the trajectory</span>
<span class="sd">    with compressed datasets, set ``compression=&#39;gzip&#39;``, ``compression=&#39;lzf&#39;``</span>
<span class="sd">    , etc. See `H5PY compression options`_ for all supported modes of</span>
<span class="sd">    compression. An additional argument, `compression_opts`, can be used to</span>
<span class="sd">    fine tune the level of compression. For example, for GZIP compression,</span>
<span class="sd">    `compression_opts` can be set to 1 for minimum compression and 9 for</span>
<span class="sd">    maximum compression.</span>

<span class="sd">    .. rubric:: HDF5 Chunking</span>

<span class="sd">    HDF5 datasets can be *chunked*, meaning the dataset can be split into equal</span>
<span class="sd">    sized pieces and stored in different, noncontiguous places on disk.</span>
<span class="sd">    If HDF5 tries to read an element from a chunked dataset, the *entire*</span>
<span class="sd">    dataset must be read, therefore an ill-thought-out chunking scheme can</span>
<span class="sd">    drastically effect file I/O performance. In the case of all MDAnalysis</span>
<span class="sd">    writers, in general, the number of frames being written is not known</span>
<span class="sd">    apriori by the writer, therefore the HDF5 must be extendable. However, the</span>
<span class="sd">    allocation of diskspace is defined when the dataset is created, therefore</span>
<span class="sd">    extendable HDF5 datasets *must* be chunked so as to allow dynamic storage</span>
<span class="sd">    on disk of any incoming data to the writer. In such cases where chunking</span>
<span class="sd">    isn&#39;t explicity defined by the user, H5PY automatically selects a chunk</span>
<span class="sd">    shape via an algorithm that attempts to make mostly square chunks between</span>
<span class="sd">    1 KiB - 1 MiB, however this can lead to suboptimal I/O performance.</span>
<span class="sd">    :class:`H5MDWriter` uses a default chunk shape of ``(1, n_atoms, 3)`` so</span>
<span class="sd">    as to mimic the typical access pattern of a trajectory by MDAnalysis. In</span>
<span class="sd">    our tests ([Jakupovic2021]_), this chunk shape led to a speedup on the</span>
<span class="sd">    order of 10x versus H5PY&#39;s auto-chunked shape. Users can set a custom</span>
<span class="sd">    chunk shape with the `chunks` argument. Additionaly, the datasets in a</span>
<span class="sd">    file can be written with a contiguous layout by setting ``chunks=False``,</span>
<span class="sd">    however this must be accompanied by setting `n_frames` equal to the</span>
<span class="sd">    number of frames being written, as HDF5 must know how much space to</span>
<span class="sd">    allocate on disk when creating the dataset.</span>

<span class="sd">    .. _`H5PY compression options`: https://docs.h5py.org/en/stable/high/dataset.html#filter-pipeline</span>
<span class="sd">    .. _`H5PY drivers`: https://docs.h5py.org/en/stable/high/file.html#file-drivers</span>


<span class="sd">    .. versionadded:: 2.0.0</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;H5MD&#39;</span>
    <span class="n">multiframe</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#: These variables are not written from :attr:`Timestep.data`</span>
    <span class="c1">#: dictionary to the observables group in the H5MD file</span>
    <span class="n">data_blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>

    <span class="c1">#: currently written version of the file format</span>
    <span class="n">H5MD_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># This dictionary is used to translate MDAnalysis units to H5MD units.</span>
    <span class="c1"># (https://nongnu.org/h5md/modules/units.html)</span>
    <span class="n">_unit_translation_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span>
            <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sec&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AKMA&#39;</span><span class="p">:</span> <span class="s1">&#39;AKMA&#39;</span><span class="p">},</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Angstrom&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;angstrom&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm&#39;</span><span class="p">:</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pm&#39;</span><span class="p">:</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="s1">&#39;fm&#39;</span><span class="p">},</span>
        <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Angstrom/ps&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom ps-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A/ps&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom ps-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Angstrom/fs&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom fs-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A/fs&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom fs-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Angstrom/AKMA&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom AKMA-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;A/AKMA&#39;</span><span class="p">:</span> <span class="s1">&#39;Angstrom AKMA-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm/ps&#39;</span><span class="p">:</span> <span class="s1">&#39;nm ps-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nm/ns&#39;</span><span class="p">:</span> <span class="s1">&#39;nm ns-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pm/ps&#39;</span><span class="p">:</span> <span class="s1">&#39;pm ps-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;m/s&#39;</span><span class="p">:</span> <span class="s1">&#39;m s-1&#39;</span><span class="p">},</span>
        <span class="s1">&#39;force&#39;</span><span class="p">:</span>  <span class="p">{</span>
            <span class="s1">&#39;kJ/(mol*Angstrom)&#39;</span><span class="p">:</span> <span class="s1">&#39;kJ mol-1 Angstrom-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kJ/(mol*nm)&#39;</span><span class="p">:</span> <span class="s1">&#39;kJ mol-1 nm-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Newton&#39;</span><span class="p">:</span> <span class="s1">&#39;Newton&#39;</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
            <span class="s1">&#39;J/m&#39;</span><span class="p">:</span> <span class="s1">&#39;J m-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kcal/(mol*Angstrom)&#39;</span><span class="p">:</span> <span class="s1">&#39;kcal mol-1 Angstrom-1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kcal/(mol*A)&#39;</span><span class="p">:</span> <span class="s1">&#39;kcal mol-1 Angstrom-1&#39;</span><span class="p">}}</span>

    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span><span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.25080/majora-1b6fd038-005&quot;</span><span class="p">),</span>
               <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MDAnalysis trajectory reader/writer of the H5MD&quot;</span>
               <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="nd">@due</span><span class="o">.</span><span class="n">dcite</span><span class="p">(</span><span class="n">Doi</span><span class="p">(</span><span class="s2">&quot;10.1016/j.cpc.2014.01.018&quot;</span><span class="p">),</span>
               <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Specifications of the H5MD standard&quot;</span><span class="p">,</span>
               <span class="n">path</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">convert_units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">compression_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">forces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lengthunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">velocityunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forceunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                 <span class="n">author_email</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;MDAnalysis&#39;</span><span class="p">,</span>
                 <span class="n">creator_version</span><span class="o">=</span><span class="n">mda</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_H5PY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;H5MDWriter: Please install h5py&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">n_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;H5MDWriter: no atoms in output trajectory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">driver</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">==</span> <span class="s1">&#39;mpio&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;H5MDWriter: parallel writing with MPI I/O &quot;</span>
                             <span class="s2">&quot;is not currently supported.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="n">n_atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="n">n_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">chunks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;H5MDWriter must know how many frames will be &quot;</span>
                             <span class="s2">&quot;written if ``chunks=False``.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_opts</span> <span class="o">=</span> <span class="n">compression_opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">convert_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The writer defaults to writing all data from the parent Timestep if</span>
        <span class="c1"># it exists. If these are True, the writer will check each</span>
        <span class="c1"># Timestep.has_*  value and fill the self._has dictionary accordingly</span>
        <span class="c1"># in _initialize_hdf5_datasets()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_positions</span> <span class="o">=</span> <span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_velocities</span> <span class="o">=</span> <span class="n">velocities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_forces</span> <span class="o">=</span> <span class="n">forces</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_positions</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_velocities</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_velocities</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one of positions, velocities, or &quot;</span>
                             <span class="s2">&quot;forces must be set to ``True``.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">timeunit</span><span class="p">,</span>
                           <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">lengthunit</span><span class="p">,</span>
                           <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="n">velocityunit</span><span class="p">,</span>
                           <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="n">forceunit</span><span class="p">}</span>

        <span class="c1"># Pull out various keywords to store metadata in &#39;h5md&#39; group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">author</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_email</span> <span class="o">=</span> <span class="n">author_email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">creator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator_version</span> <span class="o">=</span> <span class="n">creator_version</span>

    <span class="k">def</span> <span class="nf">_write_next_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write information associated with ``ag`` at current frame</span>
<span class="sd">        into trajectory</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ag : AtomGroup or Universe</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Atomgroup?</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Universe?</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">ts</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;Input obj is neither an AtomGroup or Universe&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;H5MDWriter: Timestep does not have&quot;</span>
                          <span class="s2">&quot; the correct number of atoms&quot;</span><span class="p">)</span>

        <span class="c1"># This should only be called once when first timestep is read.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_determine_units</span><span class="p">(</span><span class="n">ag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_file</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_hdf5_datasets</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_next_timestep</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_determine_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;determine which units the file will be written with</span>

<span class="sd">        By default, it fills the :attr:`self.units` dictionary by copying the</span>
<span class="sd">        units dictionary of the parent file. Because H5MD files have no</span>
<span class="sd">        standard unit restrictions, users may pass a kwarg in ``(timeunit,</span>
<span class="sd">        lengthunit, velocityunit, forceunit)`` to the writer so long as</span>
<span class="sd">        MDAnalysis has a conversion factor for it (:exc:`ValueError` raised if</span>
<span class="sd">        it does not). These custom unit arguments must be in</span>
<span class="sd">        `MDAnalysis notation`_. If custom units are supplied from the user,</span>
<span class="sd">        :attr`self.units[unit]` is replaced with the corresponding</span>
<span class="sd">        `unit` argument.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># set user input units</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_units</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a unit recognized by&quot;</span>
                                     <span class="s2">&quot; MDAnalysis. Allowed units are:&quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot; For more information on units, see&quot;</span>
                                     <span class="s2">&quot; `MDAnalysis units`_.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="c1"># check if all units are None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The trajectory has no units, but &quot;</span>
                                 <span class="s2">&quot;`convert_units` is set to ``True`` by &quot;</span>
                                 <span class="s2">&quot;default in MDAnalysis. To write the file &quot;</span>
                                 <span class="s2">&quot;with no units, set ``convert_units=False``.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Opens file with `H5PY`_ library and fills in metadata from kwargs.</span>

<span class="sd">        :attr:`self.h5md_file` becomes file handle that links to root level.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">)</span>

        <span class="c1"># fill in H5MD metadata from kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;h5md&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H5MD_VERSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md/author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md/author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;creator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md/creator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;h5md/creator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_version</span>

    <span class="k">def</span> <span class="nf">_initialize_hdf5_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;initializes all datasets that will be written to by</span>
<span class="sd">        :meth:`_write_next_timestep`</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        :exc:`NoDataError` is raised if no positions, velocities, or forces are</span>
<span class="sd">        found in the input trajectory. While the H5MD standard allows for this</span>
<span class="sd">        case, :class:`H5MDReader` cannot currently read files without at least</span>
<span class="sd">        one of these three groups. A future change to both the reader and</span>
<span class="sd">        writer will allow this case.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># for keeping track of where to write in the dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># ask the parent file if it has positions, velocities, and forces</span>
        <span class="c1"># if prompted by the writer with the self._write_* attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;has_</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_write_</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                     <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                     <span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">,</span> <span class="s1">&#39;forces&#39;</span><span class="p">))}</span>

        <span class="c1"># initialize trajectory group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;trajectory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="p">[</span><span class="s1">&#39;particles/trajectory&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_blacklist</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5md_file</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;observables&#39;</span><span class="p">)</span>

        <span class="c1"># box group is required for every group in &#39;particles&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;boundary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s1">&#39;edges&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s1">&#39;box/edges/value&#39;</span><span class="p">,</span>
                                                     <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                     <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s1">&#39;box/edges/step&#39;</span><span class="p">,</span>
                                                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
                                                    <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s1">&#39;box/edges/time&#39;</span><span class="p">,</span>
                                                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
                                                    <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if no box, boundary attr must be &quot;none&quot; according to H5MD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;boundary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_step_and_time_datasets</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_trajectory_dataset</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;position/value&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_trajectory_dataset</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;velocity/value&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">,</span> <span class="s1">&#39;velocity&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_trajectory_dataset</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;force/value&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">)</span>

        <span class="c1"># intialize observable datasets from ts.data dictionary that</span>
        <span class="c1"># are NOT in self.data_blacklist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_observables_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_create_step_and_time_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to initialize a dataset for step and time</span>

<span class="sd">        Hunts down first available location to create the step and time</span>
<span class="sd">        datasets. This should only be called if the trajectory has no</span>
<span class="sd">        dimension, otherwise the &#39;box/edges&#39; group creates step and time</span>
<span class="sd">        datasets since &#39;box&#39; is the only required group in &#39;particles&#39;.</span>

<span class="sd">        :attr:`self._step` and :attr`self._time` serve as links to the created</span>
<span class="sd">        datasets that other datasets can also point to for their step and time.</span>
<span class="sd">        This serves two purposes:</span>
<span class="sd">            1. Avoid redundant writing of multiple datasets that share the</span>
<span class="sd">               same step and time data.</span>
<span class="sd">            2. In HDF5, each chunked dataset has a cache (default 1 MiB),</span>
<span class="sd">               so only 1 read is required to access step and time data</span>
<span class="sd">               for all datasets that share the same step and time.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/step&#39;</span><span class="p">,</span>
                                                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
                                                        <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/time&#39;</span><span class="p">,</span>
                                                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
                                                        <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_create_trajectory_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to initialize a dataset for</span>
<span class="sd">        position, velocity, and force&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">maxshape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">maxshape</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">chunks</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">,</span>
                                   <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="n">maxshape</span><span class="o">=</span><span class="n">maxshape</span><span class="p">,</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                   <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                                   <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span>
                                   <span class="n">compression_opts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression_opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>

    <span class="k">def</span> <span class="nf">_create_observables_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to initialize a dataset for each observable&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="c1"># guarantee ints and floats have a shape ()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">,</span>
                                   <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">/time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>

    <span class="k">def</span> <span class="nf">_set_attr_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to set a &#39;unit&#39; attribute for an HDF5 dataset&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_translation_dict</span><span class="p">[</span><span class="n">unit</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">unit</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write coordinates and unitcell information to H5MD file.</span>

<span class="sd">        Do not call this method directly; instead use</span>
<span class="sd">        :meth:`write` because some essential setup is done</span>
<span class="sd">        there before writing the first frame.</span>

<span class="sd">        The first dimension of each dataset is extended by +1 and</span>
<span class="sd">        then the data is written to the new slot.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Writing H5MD files with fancy trajectory slicing where the Timestep</span>
<span class="sd">        does not increase monotonically such as ``u.trajectory[[2,1,0]]``</span>
<span class="sd">        or ``u.trajectory[[0,1,2,0,1,2]]`` raises a :exc:`ValueError` as this</span>
<span class="sd">        violates the rules of the step dataset in the H5MD standard.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>

        <span class="c1"># H5MD step refers to the integration step at which the data were</span>
        <span class="c1"># sampled, therefore ts.data[&#39;step&#39;] is the most appropriate value</span>
        <span class="c1"># to use. However, step is also necessary in H5MD to allow</span>
        <span class="c1"># temporal matching of the data, so ts.frame is used as an alternative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The H5MD standard dictates that the step &quot;</span>
                             <span class="s2">&quot;dataset must increase monotonically in value.&quot;</span><span class="p">)</span>

        <span class="c1"># the dataset.resize() method should work with any chunk shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="o">.</span><span class="n">write_direct</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">triclinic_dimensions</span><span class="p">,</span>
                                     <span class="n">dest_sel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="c1"># These datasets are not resized if n_frames was provided as an</span>
        <span class="c1"># argument, as they were initialized with their full size.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="o">.</span><span class="n">write_direct</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="n">dest_sel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="o">.</span><span class="n">write_direct</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">velocities</span><span class="p">,</span> <span class="n">dest_sel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="o">.</span><span class="n">write_direct</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span> <span class="n">dest_sel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obsv</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">/value&#39;</span><span class="p">]</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_dataset_with_units</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_convert_dataset_with_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;convert values in the dataset arrays with self.units dictionary&quot;&quot;&quot;</span>

        <span class="c1"># Note: simply doing convert_pos_to_native(self._pos[-1]) does not</span>
        <span class="c1"># actually change the values in the dataset, so assignment required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_velocities_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_forces_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if writer is writing positions from Timestep.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if writer is writing velocities from Timestep.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if writer is writing forces from Timestep.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="H5PYPicklable">
<a class="viewcode-back" href="../../../documentation_pages/coordinates/H5MD.html#MDAnalysis.coordinates.H5MD.H5PYPicklable">[docs]</a>
<span class="k">class</span> <span class="nc">H5PYPicklable</span><span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;H5PY file object (read-only) that can be pickled.</span>

<span class="sd">    This class provides a file-like object (as returned by</span>
<span class="sd">    :class:`h5py.File`) that,</span>
<span class="sd">    unlike standard Python file objects,</span>
<span class="sd">    can be pickled. Only read mode is supported.</span>

<span class="sd">    When the file is pickled, filename, mode, driver, and comm of</span>
<span class="sd">    :class:`h5py.File` in the file are saved. On unpickling, the file</span>
<span class="sd">    is opened by filename, mode, driver. This means that for a successful</span>
<span class="sd">    unpickle, the original file still has to be accessible with its filename.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str or file-like</span>
<span class="sd">        a filename given a text or byte string.</span>
<span class="sd">    driver : str (optional)</span>
<span class="sd">        H5PY file driver used to open H5MD file</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ::</span>

<span class="sd">        f = H5PYPicklable(&#39;filename&#39;, &#39;r&#39;)</span>
<span class="sd">        print(f[&#39;particles/trajectory/position/value&#39;][0])</span>
<span class="sd">        f.close()</span>

<span class="sd">    can also be used as context manager::</span>

<span class="sd">        with H5PYPicklable(&#39;filename&#39;, &#39;r&#39;):</span>
<span class="sd">            print(f[&#39;particles/trajectory/position/value&#39;][0])</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Pickling of an `h5py.File` opened with `driver=&quot;mpio&quot;` and an MPI</span>
<span class="sd">    communicator is currently not supported</span>

<span class="sd">    See Also</span>
<span class="sd">    ---------</span>
<span class="sd">    :class:`MDAnalysis.lib.picklable_file_io.FileIOPicklable`</span>
<span class="sd">    :class:`MDAnalysis.lib.picklable_file_io.BufferIOPicklable`</span>
<span class="sd">    :class:`MDAnalysis.lib.picklable_file_io.TextIOPicklable`</span>
<span class="sd">    :class:`MDAnalysis.lib.picklable_file_io.GzipPicklable`</span>
<span class="sd">    :class:`MDAnalysis.lib.picklable_file_io.BZ2Picklable`</span>


<span class="sd">    .. versionadded:: 2.0.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>
        <span class="c1"># Current issues: Need a way to retrieve MPI communicator object</span>
        <span class="c1"># from self and pickle MPI.Comm object. Parallel driver is excluded</span>
        <span class="c1"># from test because h5py calls for an MPI configuration when driver is</span>
        <span class="c1"># &#39;mpio&#39;, so this will need to be patched in the test function.</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s1">&#39;mpio&#39;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Parallel pickling of `h5py.File` with&quot;</span>  <span class="c1"># pragma: no cover</span>
                            <span class="s2">&quot; &#39;mpio&#39; driver is currently not supported.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="n">driver</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                      <span class="n">mode</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
                      <span class="n">driver</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override the h5py getnewargs to skip its error message&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2024, Naveen Michaud-Agrawal, Elizabeth J. Denning, Christian Beckstein (logo), Joshua L. Adelman, Henok Ademtew, Shobhit Agarwal, Aya M. Alaa, Irfan Alibay, Kazi Shudipto Amin, Anshul Angaria, Luís Pedro Borges Araújo, Balasubramanian, Utkarsh Bansal, Patricio Barletta, Leonardo Barneschi, Jonathan Barnoud, Estefania Barreto-Ojeda, Tone Bengtsen, Alejandro Bernardin, Ninad Bhat, Mateusz Bieniek, Kavya Bisht, Wouter Boomsma, Jose Borreguero, Cédric Bouysset, Kevin Boyd, Meet Brijwani, Bart Bruininks, Sébastien Buchoux, Sören von Bülow, Yantong Cai, David Caplan, Yuanyu Chang, Pratham Chauhan, Matthieu Chavent, Haochuan Chen, Xu Hong Chen, Kathleen Clark, Jennifer A Clark, Orion Cohen, Charlie Cook, Ruggero Cortini, Nicholas Craven, Ramon Crehuet, Davide Cruz, Robert Delgado, John Detlefs, Xavier Deupi, Bradley Dice, Jan Domanski, David L. Dotson, Mark D. Driver, Ali Ehlen, Daniel J. Evans, Shujie Fan, Bjarne Feddersen, Lennard van der Feltz, Jake Fennick, Philip Fowler, Guillaume Fraux, Anirvinya G, Michael Gecht, Ahmed Salah Ghoneim, Mikhail Glagolev, William Glass, Jenna M. Swarthout Goddard, Joseph Goose, Alexander Gorfer, Richard J. Gowers, Lukas Grossar, Abhinav Gupta, Akshay Gupta, Pratik Gupta, Sumit Gupta, Benjamin Hall, Ameya Harmalkar, Ivan Hristov, Eugen Hruska, Kyle J. Huston, Siddharth Jain, Edis Jakupovic, Joe Jordan, Henrik Jäger, Uma D Kadam, Aditya Kamath, Jon Kapla, Ian M. Kenney, Aditya Keshari, Haleema Khan, Navya Khare, Utsav Khatu, Andrew William King, Henry Kobin, Abhishek A. Kognole, Kosuke Kudo, Atharva Kulkarni, Manish Kumar, Mohit Kumar, Shubham Kumar, Alia Lescoulie, Zhenbo Li, Max Linke, Philip Loche, Jinju Lu, Hugo MacDermott-Opeskin, Shaivi Malik, Egor Marin, Domenico Marson, Micaela Matta, Andrew R. McCluskey, Robert McGibbon, Kurt McKee, Rocco Meli, Manuel Nuno Melo, Marcelo C. R. Melo, Dominik &#39;Rathann&#39; Mierzejewski, David Minh, Geongi Moon, Sampurna Mukherjee, Henry Mull, Morgan L. Nance, Fiona B. Naughton, Alex Nesterenko, Hai Nguyen, Sang Young Noh, Meghan Osato, Daniele Padula, Nabarun Pal, Mattia F. Palermo, Dimitrios Papageorgiou, Rafael R. Pappalardo, Vishal Parmar, Danny Parton, Shakul Pathak, Christian Pfaendner, Joshua L. Phillips, Marcelo D. Poleto, Hannah Pollak, Kashish Punjani, Michael Quevillon, Vedant Rathore, Tyler Reddy, Pedro Reis, Paul Rigor, Andrea Rizzi, Xiaoxu Ruan, Carlos Yanez S., Utkarsh Saxena, Moritz Schaeffler, Alexander Schlaich, Marcello Sega, Ricky Sexton, Sean L. Seyler, Faraaz Shah, Sulay Shah, Abhishek Shandilya, Shubham Sharma, Laksh Krishna Sharma, Rishabh Shukla, Karthikeyan Singaravelan, Tamandeep Singh, Brigitta Sipőcz, Paul Smith, Andy Somogyi, Caio S. Souza, Kai Niklas Spauszus, David van der Spoel, Shantanu Srivastava, Lukas Stelzl, Jan Stevens, Gorman Stock, Philipp Stärk, Johannes Stöckelmaier, Fenil Suchak, Ayush Suhane, Filip T. Szczypiński, Sukeerti T, Matthijs Tadema, Valerij Talagayev, Joao Miguel Correia Teixeira, Paarth Thadani, Matthew W. Thompson, Hao Tian, Matteo Tiberti, Zaheer Timol, Wiep van der Toorn, Mieczyslaw Torchala, Aditi Tripathi, Heet Vekariya, Mark Verma, Josh Vermaas, Isaac Virshup, Lily Wang, Leon Wehrhan, Nestor Wendt, Lawson Woods, Zhiyi Wu, Tengyu Xie, Zhuyi Xue, Mingyi Xue, Alexander Yang, Juan Eiros Zamora, Johannes Zeman, Yibo Zhang, Raymond Zhao, Yuxuan Zhuang, Fabian Zills, and Oliver Beckstein.</p>
  </div>

  

<div class="footer"><p>Please see
    our <a href="https://www.mdanalysis.org/pages/privacy/">Privacy Policy</a>
    to learn how <a href="https://www.mdanalysis.org">MDAnalysis</a> collects data.</p>
    <script data-goatcounter="https://mdanalysis.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
    var versions_json_url = 'https://docs.mdanalysis.org/versions.json'
</script>

<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"></span>
        2.8.0-dev0
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
        <dl id="versionselector">
            <dt>Other Versions</dt>
        </dl>

    </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>