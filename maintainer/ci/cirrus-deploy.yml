build_and_store_wheels: &BUILD_AND_STORE_WHEELS
  install_cibuildwheel_script:
    - python -m pip install cibuildwheel==2.12.3
  run_cibuildwheel_script:
    - cibuildwheel ./package
  wheels_artifacts:
    path: "wheelhouse/*"


linux_aarch64_wheel_task:
  arm_container:
    image: python:latest
    cpu: 8
    memory: 8G
  env:
    CIBW_BUILD: cp39-manylinux* cp310-manylinux* cp311-manylinux*

  build_script: |
    python3 --version
    python --version
  <<: *BUILD_AND_STORE_WHEELS


macos_arm64_wheel_task:
  macos_instance:
    image: ghcr.io/cirruslabs/macos-monterey-xcode:14
  env:
    CIBW_BUILD: cp39-* cp310-* cp311-*
    PATH: /opt/homebrew/opt/python@3.10/bin:$PATH

  build_script: |
    brew install python@3.10
    ln -s python3 /opt/homebrew/opt/python@3.10/bin/python
    python --version
    python3 --version
  <<: *BUILD_AND_STORE_WHEELS


wheel_upload:
  depends_on:
    - macos_arm64_wheel_task
    - linux_aarch64_wheel_task
  container:
    image: python:latest
  env:
    TESTPYPI: ENCRYPTED[LOOKATMEIMATOKEN]
    PYPI: ENCRYPTED[NEVERGONNAGIVEYOUUPNEVERGONNALETYOUDOWNNEVERGONNAEATPARSNIPS]
  uploady_script:
    curl https://api.cirrus-ci.com/v1/artifact/build/$CIRRUS_BUILD_ID/wheels.zip --output wheels.zip
    unzip wheels.zip
    ls *
    ls wheels
    python --version
    python3 --version
    echo "Hey Nate, how's life?"
