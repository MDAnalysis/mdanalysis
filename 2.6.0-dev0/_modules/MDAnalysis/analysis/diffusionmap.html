<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDAnalysis.analysis.diffusionmap &mdash; MDAnalysis 2.6.0-dev0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/msmb.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/mdanalysis-logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/js/versions.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 2.6.0-dev0 documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/mdanalysis-logo-thin.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.6.0-dev0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/overview.html">1. Overview over MDAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology.html">2. The topology system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections.html">3. Selection commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/analysis_modules.html">4. Analysis modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/topology_modules.html">5. Topology modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/coordinates_modules.html">6. Coordinates modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/converters.html">7. Converter modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/trajectory_transformations.html">8. Trajectory transformations (“on-the-fly” transformations)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/selections_modules.html">9. Selection exporters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/auxiliary_modules.html">10. Auxiliary modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/core_modules.html">11. Core modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/visualization_modules.html">12. Visualization modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/lib_modules.html">13. Library functions — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.lib</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/version.html">14. Version information for MDAnalysis - <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.version</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/units.html">15. Constants and unit conversion — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.units</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/exceptions.html">16. Custom exceptions and warnings — <code class="xref py py-mod docutils literal notranslate"><span class="pre">MDAnalysis.exceptions</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation_pages/references.html">17. References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MDAnalysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">MDAnalysis.analysis.diffusionmap</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MDAnalysis.analysis.diffusionmap</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c1"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span>
<span class="c1">#</span>
<span class="c1"># MDAnalysis --- https://www.mdanalysis.org</span>
<span class="c1"># Copyright (c) 2006-2017 The MDAnalysis Development Team and contributors</span>
<span class="c1"># (see the file AUTHORS for the full list of names)</span>
<span class="c1">#</span>
<span class="c1"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c1">#</span>
<span class="c1"># Please cite your use of MDAnalysis in published work:</span>
<span class="c1">#</span>
<span class="c1"># R. J. Gowers, M. Linke, J. Barnoud, T. J. E. Reddy, M. N. Melo, S. L. Seyler,</span>
<span class="c1"># D. L. Dotson, J. Domanski, S. Buchoux, I. M. Kenney, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Python package for the rapid analysis of molecular dynamics</span>
<span class="c1"># simulations. In S. Benthall and S. Rostrup editors, Proceedings of the 15th</span>
<span class="c1"># Python in Science Conference, pages 102-109, Austin, TX, 2016. SciPy.</span>
<span class="c1"># doi: 10.25080/majora-629e541a-00e</span>
<span class="c1">#</span>
<span class="c1"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c1"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c1"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Diffusion map --- :mod:`MDAnalysis.analysis.diffusionmap`</span>
<span class="sd">=====================================================================</span>

<span class="sd">:Authors: Eugen Hruska, John Detlefs</span>
<span class="sd">:Year: 2016</span>
<span class="sd">:Copyright: GNU Public License v2</span>

<span class="sd">This module contains the non-linear dimension reduction method diffusion map.</span>
<span class="sd">The eigenvectors of a diffusion matrix represent the &#39;collective coordinates&#39;</span>
<span class="sd">of a molecule; the largest eigenvalues are the more dominant collective</span>
<span class="sd">coordinates. Assigning physical meaning to the &#39;collective coordinates&#39; is a</span>
<span class="sd">fundamentally difficult problem. The time complexity of the diffusion map is</span>
<span class="sd">:math:`O(N^3)`, where N is the number of frames in the trajectory, and the in-memory</span>
<span class="sd">storage complexity is :math:`O(N^2)`. Instead of a single trajectory a sample of</span>
<span class="sd">protein structures can be used. The sample should be equilibrated, at least</span>
<span class="sd">locally. The order of the sampled structures in the trajectory is irrelevant.</span>

<span class="sd">The :ref:`Diffusion-Map-tutorial` shows how to use diffusion map for dimension</span>
<span class="sd">reduction.</span>

<span class="sd">More details about diffusion maps are in</span>
<span class="sd">:cite:p:`deLaPorte2008,Coifman-Lafon,Ferguson2011,Clementi2011`.</span>

<span class="sd">.. _Diffusion-Map-tutorial:</span>

<span class="sd">Diffusion Map tutorial</span>
<span class="sd">----------------------</span>

<span class="sd">The example uses files provided as part of the MDAnalysis test suite</span>
<span class="sd">(in the variables :data:`~MDAnalysis.tests.datafiles.PSF` and</span>
<span class="sd">:data:`~MDAnalysis.tests.datafiles.DCD`). This tutorial shows how to use the</span>
<span class="sd">Diffusion Map class.</span>

<span class="sd">First load all modules and test data</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   import MDAnalysis as mda</span>
<span class="sd">   import MDAnalysis.analysis.diffusionmap as diffusionmap</span>
<span class="sd">   from MDAnalysis.tests.datafiles import PSF, DCD</span>

<span class="sd">Given a universe or atom group, we can create and eigenvalue decompose</span>
<span class="sd">the Diffusion Matrix from that trajectory using :class:`DiffusionMap`:: and get</span>
<span class="sd">the corresponding eigenvalues and eigenvectors.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   u = mda.Universe(PSF,DCD)</span>

<span class="sd">We leave determination of the appropriate scale parameter epsilon to the user,</span>
<span class="sd">:cite:p:`Clementi2011` uses a complex method involving the k-nearest-neighbors</span>
<span class="sd">of a trajectory frame, whereas others simple use a trial-and-error approach</span>
<span class="sd">with a constant epsilon. Currently, the constant epsilon method is implemented</span>
<span class="sd">by MDAnalysis.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   dmap = diffusionmap.DiffusionMap(u, select=&#39;backbone&#39;, epsilon=2)</span>
<span class="sd">   dmap.run()</span>

<span class="sd">From here we can perform an embedding onto the k dominant eigenvectors. The</span>
<span class="sd">non-linearity of the map means there is no explicit relationship between the</span>
<span class="sd">lower dimensional space and our original trajectory. However, this is an</span>
<span class="sd">isometry (distance preserving map), which means that points close in the lower</span>
<span class="sd">dimensional space are close in the higher-dimensional space and vice versa.</span>
<span class="sd">In order to embed into the most relevant low-dimensional space, there should</span>
<span class="sd">exist some number of dominant eigenvectors, whose corresponding eigenvalues</span>
<span class="sd">diminish at a constant rate until falling off, this is referred to as a</span>
<span class="sd">spectral gap and should be somewhat apparent for a system at equilibrium with a</span>
<span class="sd">high number of frames.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   import matplotlib.pyplot as plt</span>
<span class="sd">   f, ax = plt.subplots()</span>
<span class="sd">   upper_limit = # some reasonably high number less than the n_eigenvectors</span>
<span class="sd">   ax.plot(dmap.eigenvalues[:upper_limit])</span>
<span class="sd">   ax.set(xlabel =&#39;eigenvalue index&#39;, ylabel=&#39;eigenvalue&#39;)</span>
<span class="sd">   plt.tight_layout()</span>

<span class="sd">From here we can transform into the diffusion space</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   num_eigenvectors = # some number less than the number of frames after</span>
<span class="sd">   # inspecting for the spectral gap</span>
<span class="sd">   fit = dmap.transform(num_eigenvectors, time=1)</span>

<span class="sd">It can be difficult to interpret the data, and is left as a task</span>
<span class="sd">for the user. The `diffusion distance` between frames i and j is best</span>
<span class="sd">approximated by the euclidean distance  between rows i and j of</span>
<span class="sd">self.diffusion_space.</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. autoclass:: DiffusionMap</span>
<span class="sd">.. autoclass:: DistanceMatrix</span>

<span class="sd">References</span>
<span class="sd">----------</span>

<span class="sd">If you use this Dimension Reduction method in a publication, please</span>
<span class="sd">cite :cite:p:`Coifman-Lafon`.</span>

<span class="sd">If you choose the default metric, this module uses the fast QCP algorithm</span>
<span class="sd">:cite:p:`Theobald2005` to calculate the root mean square distance (RMSD)</span>
<span class="sd">between two coordinate sets (as implemented in</span>
<span class="sd">:func:`MDAnalysis.lib.qcprot.CalcRMSDRotationalMatrix`).  When using this</span>
<span class="sd">module in published work please :cite:p:`Theobald2005`.</span>


<span class="sd">.. bibliography::</span>
<span class="sd">    :filter: False</span>
<span class="sd">    :style: MDA</span>

<span class="sd">    Coifman-Lafon</span>
<span class="sd">    deLaPorte2008</span>
<span class="sd">    Clementi2011</span>
<span class="sd">    Ferguson2011</span>
<span class="sd">    Theobald2005</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">MDAnalysis.core.universe</span> <span class="kn">import</span> <span class="n">Universe</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.core.groups</span> <span class="kn">import</span> <span class="n">AtomGroup</span><span class="p">,</span> <span class="n">UpdatingAtomGroup</span>
<span class="kn">from</span> <span class="nn">.rms</span> <span class="kn">import</span> <span class="n">rmsd</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">AnalysisBase</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;MDAnalysis.analysis.diffusionmap&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="DistanceMatrix"><a class="viewcode-back" href="../../../documentation_pages/analysis/diffusionmap.html#MDAnalysis.analysis.diffusionmap.DistanceMatrix">[docs]</a><span class="k">class</span> <span class="nc">DistanceMatrix</span><span class="p">(</span><span class="n">AnalysisBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the pairwise distance between each frame in a trajectory</span>
<span class="sd">    using a given metric</span>

<span class="sd">    A distance matrix can be initialized on its own and used as an</span>
<span class="sd">    initialization argument in :class:`DiffusionMap`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    universe : `~MDAnalysis.core.universe.Universe` or `~MDAnalysis.core.groups.AtomGroup`</span>
<span class="sd">        The MD Trajectory for dimension reduction, remember that</span>
<span class="sd">        computational cost of eigenvalue decomposition</span>
<span class="sd">        scales at O(N^3) where N is the number of frames.</span>
<span class="sd">        Cost can be reduced by increasing step interval or specifying a</span>
<span class="sd">        start and stop value when calling :meth:`DistanceMatrix.run`.</span>
<span class="sd">    select : str, optional</span>
<span class="sd">        Any valid selection string for</span>
<span class="sd">        :meth:`~MDAnalysis.core.groups.AtomGroup.select_atoms`</span>
<span class="sd">        This selection of atoms is used to calculate the RMSD between</span>
<span class="sd">        different frames. Water should be excluded.</span>
<span class="sd">    metric : function, optional</span>
<span class="sd">        Maps two numpy arrays to a float, is positive definite and</span>
<span class="sd">        symmetric. The API for a metric requires that the arrays must have</span>
<span class="sd">        equal length, and that the function should have weights as an</span>
<span class="sd">        optional argument. Weights give each index value its own weight for</span>
<span class="sd">        the metric calculation over the entire arrays. Default: metric is</span>
<span class="sd">        set to rms.rmsd().</span>
<span class="sd">    cutoff : float, optional</span>
<span class="sd">        Specify a given cutoff for metric values to be considered equal,</span>
<span class="sd">        Default: 1EO-5</span>
<span class="sd">    weights : array, optional</span>
<span class="sd">        Weights to be given to coordinates for metric calculation</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">            Show detailed progress of the calculation if set to ``True``; the</span>
<span class="sd">            default is ``False``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : `~MDAnalysis.core.groups.AtomGroup`</span>
<span class="sd">        Selected atoms in trajectory subject to dimension reduction</span>
<span class="sd">    results.dist_matrix : numpy.ndarray, (n_frames, n_frames)</span>
<span class="sd">        Array of all possible ij metric distances between frames in trajectory.</span>
<span class="sd">        This matrix is symmetric with zeros on the diagonal.</span>

<span class="sd">        .. versionadded:: 2.0.0</span>

<span class="sd">    dist_matrix : numpy.ndarray, (n_frames, n_frames)</span>

<span class="sd">        .. deprecated:: 2.0.0</span>
<span class="sd">                 Will be removed in MDAnalysis 3.0.0. Please use</span>
<span class="sd">                 :attr:`results.dist_matrix` instead.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Often, a custom distance matrix could be useful for local</span>
<span class="sd">    epsilon determination or other manipulations on the diffusion</span>
<span class="sd">    map method. The :class:`DistanceMatrix` exists in</span>
<span class="sd">    :mod:`~MDAnalysis.analysis.diffusionmap` and can be passed</span>
<span class="sd">    as an initialization argument for :class:`DiffusionMap`.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        import MDAnalysis as mda</span>
<span class="sd">        import MDAnalysis.analysis.diffusionmap as diffusionmap</span>
<span class="sd">        from MDAnalysis.tests.datafiles import PSF, DCD</span>

<span class="sd">    Now create the distance matrix and pass it as an argument to</span>
<span class="sd">    :class:`DiffusionMap`.</span>

<span class="sd">        u = mda.Universe(PSF,DCD)</span>
<span class="sd">        dist_matrix = diffusionmap.DistanceMatrix(u, select=&#39;all&#39;)</span>
<span class="sd">        dist_matrix.run()</span>
<span class="sd">        dmap = diffusionmap.DiffusionMap(dist_matrix)</span>
<span class="sd">        dmap.run()</span>

<span class="sd">    .. versionchanged:: 1.0.0</span>
<span class="sd">       ``save()`` method has been removed. You can use ``np.save()`` on</span>
<span class="sd">       :attr:`DistanceMatrix.results.dist_matrix` instead.</span>
<span class="sd">    .. versionchanged:: 2.0.0</span>
<span class="sd">         :attr:`dist_matrix` is now stored in a</span>
<span class="sd">         :class:`MDAnalysis.analysis.base.Results` instance.</span>
<span class="sd">    .. versionchanged:: 2.2.0</span>
<span class="sd">         :class:`DistanceMatrix` now also accepts `AtomGroup`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">rmsd</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">1E0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># remember that this must be called before referencing self.n_frames</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DistanceMatrix</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">universe</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">UpdatingAtomGroup</span><span class="p">):</span>
            <span class="n">wmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;U must be a static AtomGroup. Parsing an updating AtomGroup &quot;</span>
                    <span class="s2">&quot;will result in a static AtomGroup with the current frame &quot;</span>
                    <span class="s2">&quot;atom selection.&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wmsg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_single_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span>
        <span class="c1"># diagonal entries need not be calculated due to metric(x,x) == 0 in</span>
        <span class="c1"># theory, _ts not updated properly. Possible savings by setting a</span>
        <span class="c1"># cutoff for significant decimal places to sparsify matrix</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span><span class="p">[</span><span class="n">iframe</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">=</span> <span class="n">ts</span>
            <span class="n">j_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">(</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">j_ref</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">,</span>
                                     <span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">dist</span> <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cutoff</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">,</span>
                                                         <span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_index</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span><span class="p">[</span><span class="n">iframe</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dist_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The `dist_matrix` attribute was deprecated in &quot;</span>
                <span class="s2">&quot;MDAnalysis 2.0.0 and will be removed in MDAnalysis 3.0.0. &quot;</span>
                <span class="s2">&quot;Please use `results.dist_matrix` instead.&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wmsg</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span>

    <span class="k">def</span> <span class="nf">_conclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculated</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DiffusionMap"><a class="viewcode-back" href="../../../documentation_pages/analysis/diffusionmap.html#MDAnalysis.analysis.diffusionmap.DiffusionMap">[docs]</a><span class="k">class</span> <span class="nc">DiffusionMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Non-linear dimension reduction method</span>

<span class="sd">    Dimension reduction with diffusion mapping of selected structures in a</span>
<span class="sd">    trajectory.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    eigenvalues: array (n_frames,)</span>
<span class="sd">        Eigenvalues of the diffusion map</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    run()</span>
<span class="sd">        Constructs an anisotropic diffusion kernel and performs eigenvalue</span>
<span class="sd">        decomposition on it.</span>
<span class="sd">    transform(n_eigenvectors, time)</span>
<span class="sd">        Perform an embedding of a frame into the eigenvectors representing</span>
<span class="sd">        the collective coordinates.</span>


<span class="sd">    .. versionchanged:: 2.2.0</span>
<span class="sd">         :class:`DiffusionMap` now also accepts `AtomGroup`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        u : MDAnalysis Universe or AtomGroup or DistanceMatrix object.</span>
<span class="sd">            Can be a Universe or AtomGroup, in which case one must supply kwargs for the</span>
<span class="sd">            initialization of a DistanceMatrix. Otherwise, this can be a</span>
<span class="sd">            DistanceMatrix already initialized. Either way, this will be made</span>
<span class="sd">            into a diffusion kernel.</span>
<span class="sd">        epsilon : Float</span>
<span class="sd">            Specifies the method used for the choice of scale parameter in the</span>
<span class="sd">            diffusion map. More information in</span>
<span class="sd">            :cite:p:`Coifman-Lafon,Ferguson2011,Clementi2011`, Default: 1.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters to be passed for the initialization of a</span>
<span class="sd">            :class:`DistanceMatrix`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">AtomGroup</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Universe</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span> <span class="o">=</span> <span class="n">DistanceMatrix</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">DistanceMatrix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span> <span class="o">=</span> <span class="n">u</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;U is not a Universe or AtomGroup or DistanceMatrix and&quot;</span>
                             <span class="s2">&quot; so the DiffusionMap has no data to work with.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

<div class="viewcode-block" id="DiffusionMap.run"><a class="viewcode-back" href="../../../documentation_pages/analysis/diffusionmap.html#MDAnalysis.analysis.diffusionmap.DiffusionMap.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create and decompose the diffusion matrix in preparation</span>
<span class="sd">        for a diffusion map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : int, optional</span>
<span class="sd">            start frame of analysis</span>
<span class="sd">        stop : int, optional</span>
<span class="sd">            stop frame of analysis</span>
<span class="sd">        step : int, optional</span>
<span class="sd">            number of frames to skip between each analysed frame</span>

<span class="sd">        .. versionchanged:: 0.19.0</span>
<span class="sd">           Added start/stop/step kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># run only if distance matrix not already calculated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span><span class="o">.</span><span class="n">_calculated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="c1"># important for transform function and length of .run() method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span><span class="o">.</span><span class="n">n_frames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_frames</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The distance matrix is very large, and can &quot;</span>
                          <span class="s2">&quot;be very slow to compute. Consider picking a larger &quot;</span>
                          <span class="s2">&quot;step size in distance matrix initialization.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaled_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dist_matrix</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">dist_matrix</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">)</span>
        <span class="c1"># take negative exponent of scaled matrix to create Isotropic kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_scaled_matrix</span><span class="p">)</span>
        <span class="n">D_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D_inv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigenvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigenvectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diff</span><span class="p">)</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eigenvals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigenvals</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigenvectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigenvectors</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DiffusionMap.transform"><a class="viewcode-back" href="../../../documentation_pages/analysis/diffusionmap.html#MDAnalysis.analysis.diffusionmap.DiffusionMap.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_eigenvectors</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Embeds a trajectory via the diffusion map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        n_eigenvectors : int</span>
<span class="sd">            The number of dominant eigenvectors to be used for</span>
<span class="sd">            diffusion mapping</span>
<span class="sd">        time : float</span>
<span class="sd">            Exponent that eigenvalues are raised to for embedding, for large</span>
<span class="sd">            values, more dominant eigenvectors determine diffusion distance.</span>
<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        diffusion_space : array (n_frames, n_eigenvectors)</span>
<span class="sd">            The diffusion map embedding as defined by :cite:p:`Ferguson2011`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eigenvectors</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n_eigenvectors</span><span class="o">+</span><span class="mi">1</span><span class="p">,]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n_eigenvectors</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">time</span><span class="p">))</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2023, Naveen Michaud-Agrawal, Elizabeth J. Denning, Christian Beckstein (logo), Joshua L. Adelman, Henok Ademtew, Shobhit Agarwal, Aya M. Alaa, Irfan Alibay, Kazi Shudipto Amin, Anshul Angaria, Luís Pedro Borges Araújo, Balasubramanian, Utkarsh Bansal, Patricio Barletta, Leonardo Barneschi, Jonathan Barnoud, Estefania Barreto-Ojeda, Tone Bengtsen, Alejandro Bernardin, Ninad Bhat, Mateusz Bieniek, Kavya Bisht, Wouter Boomsma, Jose Borreguero, Cédric Bouysset, Kevin Boyd, Meet Brijwani, Bart Bruininks, Sébastien Buchoux, Sören von Bülow, Yantong Cai, David Caplan, Yuanyu Chang, Pratham Chauhan, Matthieu Chavent, Haochuan Chen, Xu Hong Chen, Kathleen Clark, Jennifer A Clark, Orion Cohen, Charlie Cook, Ruggero Cortini, Nicholas Craven, Ramon Crehuet, Davide Cruz, Robert Delgado, John Detlefs, Xavier Deupi, Jan Domanski, David L. Dotson, Mark D. Driver, Ali Ehlen, Daniel J. Evans, Shujie Fan, Bjarne Feddersen, Lennard van der Feltz, Jake Fennick, Philip Fowler, Guillaume Fraux, Anirvinya G, Ahmed Salah Ghoneim, Mikhail Glagolev, William Glass, Joseph Goose, Alexander Gorfer, Richard J. Gowers, Lukas Grossar, Abhinav Gupta, Akshay Gupta, Pratik Gupta, Benjamin Hall, Ameya Harmalkar, Ivan Hristov, Eugen Hruska, Kyle J. Huston, Siddharth Jain, Edis Jakupovic, Joe Jordan, Henrik Jäger, Uma D Kadam, Aditya Kamath, Jon Kapla, Haleema Khan, Navya Khare, Utsav Khatu, Andrew William King, Henry Kobin, Abhishek A. Kognole, Kosuke Kudo, Atharva Kulkarni, Manish Kumar, Mohit Kumar, Shubham Kumar, Alia Lescoulie, Max Linke, Philip Loche, Jinju Lu, Hugo MacDermott-Opeskin, Shaivi Malik, Egor Marin, Domenico Marson, Micaela Matta, Andrew R. McCluskey, Robert McGibbon, Rocco Meli, Manuel Nuno Melo, Marcelo C. R. Melo, Dominik &#39;Rathann&#39; Mierzejewski, Henry Mull, Morgan L. Nance, Fiona B. Naughton, Alex Nesterenko, Hai Nguyen, Sang Young Noh, Meghan Osato, Daniele Padula, Nabarun Pal, Mattia F. Palermo, Dimitrios Papageorgiou, Rafael R. Pappalardo, Vishal Parmar, Danny Parton, Shakul Pathak, Christian Pfaendner, Joshua L. Phillips, Marcelo D. Poleto, Hannah Pollak, Kashish Punjani, Michael Quevillon, Vedant Rathore, Tyler Reddy, Pedro Reis, Paul Rigor, Andrea Rizzi, Xiaoxu Ruan, Carlos Yanez S., Utkarsh Saxena, Moritz Schaeffler, Alexander Schlaich, Marcello Sega, Ricky Sexton, Sean L. Seyler, Faraaz Shah, Sulay Shah, Abhishek Shandilya, Shubham Sharma, Rishabh Shukla, Karthikeyan Singaravelan, Tamandeep Singh, Paul Smith, Andy Somogyi, Caio S. Souza, Shantanu Srivastava, Lukas Stelzl, Jan Stevens, Gorman Stock, Fenil Suchak, Ayush Suhane, Filip T. Szczypiński, Sukeerti T, Matthijs Tadema, Joao Miguel Correia Teixeira, Paarth Thadani, Matthew W. Thompson, Hao Tian, Matteo Tiberti, Wiep van der Toorn, Mieczyslaw Torchala, Aditi Tripathi, Mark Verma, Josh Vermaas, Isaac Virshup, Lily Wang, Nestor Wendt, Zhiyi Wu, Tengyu Xie, Zhuyi Xue, Mingyi Xue, Alexander Yang, Juan Eiros Zamora, Johannes Zeman, Yibo Zhang, Raymond Zhao, Yuxuan Zhuang, and Oliver Beckstein.</p>
  </div>

  
 
<div class="footer"><p>Please see
    our <a href="https://www.mdanalysis.org/pages/privacy/">Privacy Policy</a>
    to learn how <a href="https://www.mdanalysis.org">MDAnalysis</a> collects data.</p>
    <script data-goatcounter="https://mdanalysis.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
    var versions_json_url = 'https://docs.mdanalysis.org/versions.json'
</script>

<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"></span>
        2.6.0-dev0
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
        <dl id="versionselector">
            <dt>Other Versions</dt>
        </dl>

    </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>